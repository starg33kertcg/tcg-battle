<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCG Battle!</title>
    <link rel="icon" type="image/png" href="https://tcgbattle.netlify.app/images/tcg_battle_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-bangers { font-family: 'Bangers', cursive; }
        .logo-text { text-shadow: 4px 4px 0px #1f2937, -2px -2px 0 #1f2937, 2px -2px 0 #1f2937, -2px 2px 0 #1f2937, 2px 2px 0 #1f2937; }
        .disabled-card { filter: grayscale(100%); cursor: not-allowed; }
        .prize-card { transition: all 0.3s ease; border: 2px solid #6b7280; }
        .prize-card.taken {  
            background-color: #4b5563 !important;  
            color: #9ca3af !important;  
            transform: scale(0.95);  
            border-color: #374151;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .turn-indicator-glow { box-shadow: 0 0 15px 4px #22c55e; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 15px 4px #22c55e; } 70% { box-shadow: 0 0 20px 6px #16a34a; } 100% { box-shadow: 0 0 15px 4px #22c55e; } }
        .modal-backdrop { background-color: rgba(0,0,0,0.75); }

        /* New Presenter Styles */
        .presenter-prize-container {
            position: relative;
            width: 450px; /* Increased container size for larger arc */
            height: 450px;
        }
        .presenter-prize-pokeball {
            position: absolute;
            left: 50%;
            top: 50%;
            margin: -32px; /* Half of new width/height */
            width: 64px;   /* Increased size */
            height: 64px;  /* Increased size */
            border-radius: 50%;
            background: linear-gradient(to bottom, #ef4444 0%, #ef4444 50%, #f9fafb 50%, #f9fafb 100%);
            border: 3px solid #1f2937; /* Thicker border */
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .presenter-prize-pokeball::before {
            content: '';
            position: absolute;
            height: 8px; /* Thicker line */
            width: 100%;
            background: #1f2937;
        }
        .presenter-prize-pokeball::after {
            content: '';
            position: absolute;
            height: 22px; /* Larger button */
            width: 22px;  /* Larger button */
            border-radius: 50%;
            background: #f9fafb;
            border: 5px solid #1f2937; /* Thicker border */
        }
        .presenter-prize-pokeball.taken {
            filter: grayscale(100%);
        }
        
        /* Winner Animation */
        @keyframes winner-pop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .winner-animation {
            animation: winner-pop 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="text-gray-100" style="background-color: #1a1a2e;">

    <div id="app" class="relative min-h-screen">

        <section id="home-view" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
            <div class="mb-8 w-full max-w-lg">
                <img src="https://tcgbattle.netlify.app/images/tcg_battle_logo.png" alt="TCG Battle Logo" class="w-full h-auto">
            </div>
            <div class="space-y-4 w-full max-w-xs">
                <button id="create-session-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Create a new battle</button>
                <button id="join-session-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Join an existing battle</button>
            </div>
            <div class="absolute bottom-4 text-xs text-gray-500">
                <p>This app is under active development. Expect bugs and glitches.</p>
            </div>
        </section>

        <section id="tcg-selection-view" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
            <h2 class="text-4xl font-bold mb-8">Choose Your TCG</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-2xl">
                <div id="select-pokemon" class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer border-2 border-yellow-400 hover:bg-gray-600 transition-colors">
                    <img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/025.png" alt="Pokémon" class="h-24 mx-auto mb-2" onerror="this.onerror=null;this.src='https://placehold.co/150x100/78716C/FFFFFF?text=Pokemon';">
                    <h3 class="font-bold text-lg">Pokémon</h3>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center disabled-card relative flex flex-col justify-center items-center">
                    <h3 class="font-bold text-lg text-gray-400">Magic: The Gathering</h3>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">In Development</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center disabled-card relative flex flex-col justify-center items-center">
                    <h3 class="font-bold text-lg text-gray-400">Yu-Gi-Oh!</h3>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">In Development</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center disabled-card relative flex flex-col justify-center items-center">
                    <h3 class="font-bold text-lg text-gray-400">One Piece</h3>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">In Development</span>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg text-center disabled-card relative flex flex-col justify-center items-center">
                    <h3 class="font-bold text-lg text-gray-400">Lorcana</h3>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">In Development</span>
                </div>
                 <div class="bg-gray-700 p-4 rounded-lg text-center disabled-card relative flex flex-col justify-center items-center">
                    <h3 class="font-bold text-lg text-gray-400">Dragonball Z</h3>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">In Development</span>
                </div>
            </div>
             <button id="back-to-home-from-tcg" class="mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Back</button>
        </section>

        <div id="game-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Game Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold">Player Name</label>
                        <input type="text" id="player-name-input" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="Enter your name">
                    </div>
                    <div>
                        <label class="font-bold">Prize Cards</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-prizes="6" class="prize-option-btn flex-1 bg-blue-600 text-white rounded p-2">6 (Standard)</button>
                            <button data-prizes="4" class="prize-option-btn flex-1 bg-gray-600 text-white rounded p-2">4 (Pre-Release)</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-bold">Timer Type</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-timer="countdown" class="timer-type-btn flex-1 bg-blue-600 text-white rounded p-2">Countdown</button>
                            <button data-timer="chess" class="timer-type-btn flex-1 bg-gray-600 text-white rounded p-2">Chess Clock</button>
                        </div>
                    </div>
                    <div id="countdown-timer-settings">
                        <label class="font-bold">Round Time (minutes)</label>
                        <input type="number" id="countdown-minutes" value="30" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="chess-timer-settings" class="hidden">
                        <label class="font-bold">Time Per Player (minutes)</label>
                        <input type="number" id="chess-minutes" value="20" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="number-of-games-settings">
                        <label class="font-bold">Number of Games</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-mode="basic" class="game-mode-btn flex-1 bg-blue-600 text-white rounded p-2">Basic Swiss</button>
                            <button data-mode="bestOfThree" class="game-mode-btn flex-1 bg-gray-600 text-white rounded p-2">Best-of-Three</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-settings-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    <button id="confirm-create-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Create Battle</button>
                </div>
            </div>
        </div>
        
        <div id="join-session-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Join Battle</h2>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold">Your Name</label>
                        <input type="text" id="join-player-name" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="Enter your name">
                    </div>
                    <div>
                        <label class="font-bold">5-Digit Room Code</label>
                        <input type="text" id="room-code-input" maxlength="5" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1 text-center text-2xl tracking-widest" placeholder="_ _ _ _ _">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-join-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    <button id="confirm-join-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Join</button>
                </div>
            </div>
        </div>

        <div id="choose-first-player-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">Who Goes First?</h2>
                <div id="first-player-options" class="space-y-3">
                    </div>
            </div>
        </div>

        <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div id="winner-card" class="bg-gray-700 rounded-lg p-8 w-full max-w-md text-center winner-animation">
                <i class="fas fa-trophy text-yellow-400 text-6xl mb-4"></i>
                <h2 id="winner-title" class="text-4xl font-bold mb-2">WINNER!</h2>
                <p id="winner-name" class="text-3xl font-bangers tracking-wider"></p>
                <div id="winner-modal-buttons" class="mt-6">
                    </div>
            </div>
        </div>

        <div id="issue-win-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">Issue Win To...</h2>
                <div id="issue-win-options" class="space-y-3">
                    <!-- Player buttons will be injected here -->
                </div>
                <button id="cancel-issue-win-btn" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
            </div>
        </div>

        <div id="time-expired-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">Time has expired!</h2>
                <p class="mb-4">Please issue a game win or declare a tie.</p>
                <div id="time-expired-options" class="space-y-3">
                    <!-- Player buttons will be injected here -->
                </div>
            </div>
        </div>

        <section id="game-room-view" class="hidden min-h-screen flex flex-col p-2 sm:p-4">
            <header class="flex justify-between items-center mb-4">
                <div class="text-sm">
                    <p>Room: <span id="room-code-display" class="font-bold tracking-wider"></span></p>
                    <p id="player-role" class="font-bold"></p>
                </div>
                <div class="text-center">
                    <img src="https://tcgbattle.netlify.app/images/tcg_battle_logo.png" alt="TCG Battle Logo" class="h-10 mx-auto">
                </div>
                <div class="relative">
                    <button id="game-menu-btn" class="p-2"><i class="fas fa-bars fa-lg"></i></button>
                    <div id="game-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg z-20">
                        </div>
                </div>
            </header>

            <main class="flex-grow flex flex-col items-center justify-center">
                <div id="waiting-for-opponent" class="text-center">
                    <h2 class="text-2xl font-bold">Waiting for opponent...</h2>
                    <p class="text-gray-400">Share the room code to let them join.</p>
                </div>

                <div id="game-controls" class="hidden w-full max-w-lg text-center">
                    <div id="game-status-info" class="mb-4 py-6 px-3 bg-gray-900 rounded-lg">
                         <p id="game-status-text" class="text-xl font-bold text-yellow-400"></p>
                         <div id="player-turn-info" class="flex justify-around items-center mt-4 px-4">
                             <div id="player1-turn-indicator" class="p-2 rounded-lg">
                                 <p id="player1-name-turn" class="font-bold"></p>
                             </div>
                             <div id="player2-turn-indicator" class="p-2 rounded-lg">
                                 <p id="player2-name-turn" class="font-bold"></p>
                             </div>
                         </div>
                    </div>
                    
                    <div id="timer-display-controls" class="mb-4 text-center"></div>
                    
                    <h3 class="font-bold text-xl mb-2">Your Prize Cards</h3>
                    <div id="prize-card-grid" class="grid grid-cols-2 gap-3">
                        </div>
                    
                    <div id="turn-controls" class="mt-4">
                    </div>
                </div>
            </main>
        </section>

        <section id="presenter-view" class="hidden min-h-screen flex flex-col items-center justify-center p-4" style="background-color: #000000;">
            <div id="presenter-board" class="w-full max-w-7xl mx-auto relative">
                <div class="flex justify-between items-center">
                    <div id="presenter-p1-side" class="flex-1 flex flex-col items-center">
                        <div id="presenter-p1-avatar" class="w-32 h-32 md:w-48 md:h-48 p-2 rounded-lg bg-black bg-opacity-20 border-2 border-gray-500"></div>
                        <h2 id="presenter-p1-name" class="mt-2 text-2xl md:text-4xl font-bold text-white bg-black bg-opacity-20 px-4 py-1 rounded-md">Player 1</h2>
                        <p id="presenter-p1-wins" class="text-xl font-bold text-yellow-400 mt-2"></p>
                    </div>
                    
                    <div class="flex-shrink-0 mx-8">
                        <img src="https://tcgbattle.netlify.app/images/tcg_battle_logo.png" alt="TCG Battle Logo" class="w-64 md:w-80">
                        <p id="presenter-game-number" class="text-center text-3xl font-bold text-white mt-4"></p>
                    </div>

                    <div id="presenter-p2-side" class="flex-1 flex flex-col items-center">
                        <div id="presenter-p2-avatar" class="w-32 h-32 md:w-48 md:h-48 p-2 rounded-lg bg-black bg-opacity-20 border-2 border-gray-500"></div>
                        <h2 id="presenter-p2-name" class="mt-2 text-2xl md:text-4xl font-bold text-white bg-black bg-opacity-20 px-4 py-1 rounded-md">Player 2</h2>
                        <p id="presenter-p2-wins" class="text-xl font-bold text-yellow-400 mt-2"></p>
                    </div>
                </div>

                <div id="presenter-p1-prizes" class="presenter-prize-container absolute left-0 top-1/2 -translate-y-1/2"></div>
                <div id="presenter-p2-prizes" class="presenter-prize-container absolute right-0 top-1/2 -translate-y-1/2"></div>
                
                 <div id="presenter-timer-container" class="absolute bottom-[-80px] left-1/2 -translate-x-1/2 bg-black rounded-lg px-6 py-2 border-2 border-gray-600">
                    <div id="presenter-timer" class="text-5xl md:text-6xl font-mono font-bold tabular-nums text-yellow-300">00:00</div>
                    <div id="presenter-chess-timers" class="hidden w-full flex justify-around gap-8 text-4xl md:text-5xl font-mono font-bold tabular-nums">
                        <div id="presenter-chess-p1">00:00</div>
                        <div id="presenter-chess-p2">00:00</div>
                    </div>
                </div>
            </div>
            <div class="absolute top-4 right-4 text-sm text-gray-300">Room: <span id="presenter-room-code" class="font-bold"></span></div>
            <button id="fullscreen-btn" class="absolute top-4 left-4 text-white bg-black bg-opacity-25 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-50">
                <i class="fas fa-expand"></i>
            </button>
        </section>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let appState = {
        pusher: null,
        channel: null,
        myId: null,
        isHost: false,
        roomCode: null,
        view: 'home', // home, tcgSelection, gameRoom, presenter
        playerName: `Player${Math.floor(Math.random() * 900 + 100)}`,
        winnerAnnounced: false,
        game: {
            tcg: 'pokemon',
            status: 'waiting', // waiting, active, paused, finished
            prizeCount: 6,
            timerType: 'countdown', // countdown, chess
            countdownMinutes: 30,
            chessMinutes: 20,
            gameMode: 'basic', // basic, bestOfThree
            currentGame: 1,
            wins: {}, // { [playerId]: winCount }
            roundWinnerId: null,
            isTie: false,
            winnerId: null,
            players: {}, // { [id]: { name, prizesTaken: [], isHost, color, connected: true } }
            turn: null, // player id
            timerState: {
                running: false,
                startTime: null,
                elapsed: 0,
                playerTimes: {} // { [id]: timeInMillis }
            }
        },
    };

    // --- PUSHER CONFIGURATION ---
    const PUSHER_APP_KEY = '8206e71c1218d7e2a91d'; // IMPORTANT: Best to use Netlify Environment Variables
    const PUSHER_CLUSTER = 'us2';

    if (PUSHER_APP_KEY === 'YOUR_PUSHER_APP_KEY' || PUSHER_CLUSTER === 'YOUR_PUSHER_CLUSTER') {
        console.warn("Pusher key not set. Real-time features will not work.");
    }

    // --- DOM ELEMENTS ---
    const views = {
        home: document.getElementById('home-view'),
        tcgSelection: document.getElementById('tcg-selection-view'),
        gameSettingsModal: document.getElementById('game-settings-modal'),
        joinSessionModal: document.getElementById('join-session-modal'),
        gameRoom: document.getElementById('game-room-view'),
        presenter: document.getElementById('presenter-view'),
        chooseFirstPlayerModal: document.getElementById('choose-first-player-modal'),
        winnerModal: document.getElementById('winner-modal'),
        issueWinModal: document.getElementById('issue-win-modal'),
        timeExpiredModal: document.getElementById('time-expired-modal'),
    };
    
    // --- TRAINER AVATAR ---
    const trainerSilhouetteSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
    const avatarColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#8b5cf6', '#ec4899', '#f97316'];

    // --- UTILITY FUNCTIONS ---
    const generateRoomCode = () => Math.floor(10000 + Math.random() * 90000).toString();
    const formatTime = (ms) => {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    };

    // --- VIEW MANAGEMENT ---
    const showView = (viewName) => {
        appState.view = viewName;
        Object.keys(views).forEach(key => {
            if (views[key]) {
                 views[key].classList.add('hidden');
            }
        });
        if (views[viewName]) {
            views[viewName].classList.remove('hidden');
        }
    };
    
    const showModal = (modalName) => {
        if (views[modalName]) views[modalName].classList.remove('hidden');
    };
    
    const hideModal = (modalName) => {
        if (views[modalName]) views[modalName].classList.add('hidden');
    };

    // --- RENDER FUNCTIONS (UI Updates) ---
    const renderGameRoom = () => {
        if (appState.view !== 'gameRoom') return;
        const { game, myId, isHost } = appState;

        document.getElementById('room-code-display').textContent = appState.roomCode;
        document.getElementById('player-role').textContent = isHost ? 'You are the Host' : 'You are the Guest';
        
        const menuDropdown = document.getElementById('game-menu-dropdown');
        menuDropdown.innerHTML = ''; // Clear old items
        if (isHost) {
            menuDropdown.innerHTML = `
                <a href="#" id="start-game-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-blue-500 hover:text-white">Start Game</a>
                <a href="#" id="restart-round-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-yellow-500 hover:text-white">Restart Round</a>
                <a href="#" id="issue-win-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-indigo-500 hover:text-white">Issue Win</a>
                <a href="#" id="kick-guest-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-orange-500 hover:text-white">Kick Guest</a>
                <a href="#" id="end-session-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-red-500 hover:text-white">End Session</a>
                <a href="#" id="open-presenter-btn" target="_blank" class="block px-4 py-2 text-sm text-gray-200 hover:bg-purple-500 hover:text-white">Open Presenter</a>
            `;
            document.getElementById('open-presenter-btn').href = `?presenter=${appState.roomCode}`;
        } else {
             menuDropdown.innerHTML = `<a href="#" id="leave-battle-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-red-500 hover:text-white">Leave Battle</a>`;
        }


        const me = game.players[myId];
        if (!me) {
            document.getElementById('waiting-for-opponent').style.display = 'block';
            document.getElementById('game-controls').style.display = 'none';
            return;
        }

        const connectedPlayerCount = Object.values(game.players).filter(p => p.connected).length;
        
        if (game.status === 'paused') {
             document.getElementById('waiting-for-opponent').style.display = 'none';
             document.getElementById('game-controls').style.display = 'block';
        } else {
            document.getElementById('waiting-for-opponent').style.display = connectedPlayerCount < 2 ? 'block' : 'none';
            document.getElementById('game-controls').style.display = connectedPlayerCount >= 2 ? 'block' : 'none';
        }


        const prizeGrid = document.getElementById('prize-card-grid');
        prizeGrid.innerHTML = '';
        for (let i = 1; i <= game.prizeCount; i++) {
            const card = document.createElement('button');
            card.dataset.prizeId = i;
            card.className = 'prize-card p-4 sm:p-6 rounded-lg font-bold text-2xl bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed';
            card.textContent = i;
            if (me.prizesTaken.includes(i)) card.classList.add('taken');
            card.disabled = game.status !== 'active';
            prizeGrid.appendChild(card);
        }

        const p1Id = Object.keys(game.players).find(id => game.players[id].isHost);
        const p2Id = Object.keys(game.players).find(id => !game.players[id].isHost);
        const p1Indicator = document.getElementById('player1-turn-indicator');
        const p2Indicator = document.getElementById('player2-turn-indicator');
        
        if (p1Id && game.players[p1Id]) {
            const p1 = game.players[p1Id];
            const p1PrizesLeft = game.prizeCount - p1.prizesTaken.length;
            document.getElementById('player1-name-turn').textContent = `${p1.name} (${p1PrizesLeft} Prizes)`;
        }
        if (p2Id && game.players[p2Id]) {
            const p2 = game.players[p2Id];
            const p2PrizesLeft = game.prizeCount - p2.prizesTaken.length;
            document.getElementById('player2-name-turn').textContent = `${p2.name} (${p2PrizesLeft} Prizes)`;
        }

        p1Indicator.classList.remove('turn-indicator-glow');
        p2Indicator.classList.remove('turn-indicator-glow');
        if (game.turn === p1Id) p1Indicator.classList.add('turn-indicator-glow');
        if (game.turn === p2Id) p2Indicator.classList.add('turn-indicator-glow');

        let statusText = "Waiting to start...";
        if (game.status === 'active') {
            statusText = "Game in progress!";
            if (game.gameMode === 'bestOfThree') {
                statusText = `Game ${game.currentGame} of 3`;
            }
        }
        if (game.status === 'paused') statusText = "Game Paused - Opponent Disconnected";
        if (game.status === 'finished') {
            const winner = game.players[game.roundWinnerId];
            if (game.isTie) {
                statusText = "Round Tied!";
            } else if (winner) {
                statusText = `Game Over! ${winner.name} wins the round!`;
            } else {
                statusText = "Game Over!";
            }
        }
        document.getElementById('game-status-text').textContent = statusText;

        renderTimerDisplay();
        renderActionButtons();
    };

    const renderTimerDisplay = () => {
        const timerDisplay = document.getElementById('timer-display-controls');
        if (!timerDisplay) return;

        const { timerType, timerState } = appState.game;
        let html = '';

        if (timerType === 'countdown') {
            const timeRemaining = (appState.game.countdownMinutes * 60 * 1000) - timerState.elapsed;
            html = `<p class="text-4xl font-bold tabular-nums">${formatTime(timeRemaining)}</p>`;
        } else {
            const p1Id = Object.keys(appState.game.players).find(id => appState.game.players[id].isHost);
            const p2Id = Object.keys(appState.game.players).find(id => !appState.game.players[id].isHost);
            const p1Time = timerState.playerTimes[p1Id] ?? (appState.game.chessMinutes * 60000);
            const p2Time = timerState.playerTimes[p2Id] ?? (appState.game.chessMinutes * 60000);
            html = `
                <div class="flex justify-around items-center text-3xl font-bold tabular-nums">
                    <div>
                        <p class="text-sm">${p1Id ? appState.game.players[p1Id].name : 'Host'}</p>
                        <p>${formatTime(p1Time)}</p>
                    </div>
                    <div>
                        <p class="text-sm">${p2Id ? appState.game.players[p2Id].name : 'Guest'}</p>
                        <p>${formatTime(p2Time)}</p>
                    </div>
                </div>`;
        }
        timerDisplay.innerHTML = html;
    };
    
    const renderActionButtons = () => {
        const controlsContainer = document.getElementById('turn-controls');
        controlsContainer.innerHTML = '';
        if (appState.game.status !== 'active') return;

        const isMyTurn = appState.myId === appState.game.turn;

        const buttonWrapper = document.createElement('div');
        buttonWrapper.className = 'flex items-center justify-center space-x-4';

        const endTurnBtn = document.createElement('button');
        endTurnBtn.id = 'end-turn-btn';
        endTurnBtn.className = 'flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed';
        endTurnBtn.textContent = 'End Turn';
        endTurnBtn.disabled = !isMyTurn;

        const scoopBtn = document.createElement('button');
        scoopBtn.id = 'scoop-btn';
        scoopBtn.className = 'flex-shrink-0 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed';
        scoopBtn.textContent = 'SCOOP!';
        scoopBtn.disabled = appState.game.status !== 'active';

        buttonWrapper.appendChild(endTurnBtn);
        buttonWrapper.appendChild(scoopBtn);
        controlsContainer.appendChild(buttonWrapper);
    };

    const renderPresenter = () => {
        if (appState.view !== 'presenter') return;
        const { game } = appState;

        const p1Id = Object.keys(game.players).find(id => game.players[id].isHost);
        const p2Id = Object.keys(game.players).find(id => !game.players[id].isHost);
        
        const p1 = p1Id ? game.players[p1Id] : { name: 'Host', prizesTaken: [], color: '#cccccc' };
        const p2 = p2Id ? game.players[p2Id] : { name: 'Guest', prizesTaken: [], color: '#cccccc' };

        document.getElementById('presenter-p1-name').textContent = p1.name;
        document.getElementById('presenter-p2-name').textContent = p2.name;
        document.getElementById('presenter-room-code').textContent = appState.roomCode;
        
        const p1Avatar = document.getElementById('presenter-p1-avatar');
        p1Avatar.innerHTML = trainerSilhouetteSVG;
        p1Avatar.style.color = p1.color;
        p1Avatar.classList.toggle('turn-indicator-glow', game.turn === p1Id);

        const p2Avatar = document.getElementById('presenter-p2-avatar');
        p2Avatar.innerHTML = trainerSilhouetteSVG;
        p2Avatar.style.color = p2.color;
        p2Avatar.classList.toggle('turn-indicator-glow', game.turn === p2Id);

        if (game.gameMode === 'bestOfThree') {
            document.getElementById('presenter-game-number').textContent = `Game ${game.currentGame}`;
            document.getElementById('presenter-p1-wins').textContent = `${game.wins[p1Id] || 0} Wins`;
            document.getElementById('presenter-p2-wins').textContent = `${game.wins[p2Id] || 0} Wins`;
        } else {
            document.getElementById('presenter-game-number').textContent = '';
            document.getElementById('presenter-p1-wins').textContent = '';
            document.getElementById('presenter-p2-wins').textContent = '';
        }

        const renderPrizesInArc = (player, containerId, isReversed) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const numPrizes = game.prizeCount;
            const radius = 220;
            const totalAngle = 150; 
            const angleStep = numPrizes > 1 ? totalAngle / (numPrizes - 1) : 0;
            const startAngle = -75; 

            for (let i = 1; i <= numPrizes; i++) {
                const angle = startAngle + (angleStep * (i - 1));
                const radians = angle * (Math.PI / 180);

                const x = radius * Math.cos(radians);
                const y = radius * Math.sin(radians);

                const prizeEl = document.createElement('div');
                prizeEl.className = 'presenter-prize-pokeball';
                prizeEl.style.transform = `translate(${isReversed ? -x : x}px, ${y}px)`;
                
                const taken = player.prizesTaken.includes(i);
                if(taken) prizeEl.classList.add('taken');
                container.appendChild(prizeEl);
            }
        };
        renderPrizesInArc(p1, 'presenter-p1-prizes', true);
        renderPrizesInArc(p2, 'presenter-p2-prizes', false);

        const countdownTimerEl = document.getElementById('presenter-timer');
        const chessTimersEl = document.getElementById('presenter-chess-timers');
        const p1ChessEl = document.getElementById('presenter-chess-p1');
        const p2ChessEl = document.getElementById('presenter-chess-p2');

        if (game.timerType === 'countdown') {
            countdownTimerEl.classList.remove('hidden');
            chessTimersEl.classList.add('hidden');
            const timeRemaining = (appState.game.countdownMinutes * 60 * 1000) - game.timerState.elapsed;
            countdownTimerEl.textContent = formatTime(timeRemaining);
        } else {
            countdownTimerEl.classList.add('hidden');
            chessTimersEl.classList.remove('hidden');
            const p1Time = game.timerState.playerTimes[p1Id] ?? (appState.game.chessMinutes * 60000);
            const p2Time = game.timerState.playerTimes[p2Id] ?? (appState.game.chessMinutes * 60000);
            p1ChessEl.textContent = formatTime(p1Time);
            p2ChessEl.textContent = formatTime(p2Time);
            p1ChessEl.style.color = p1.color;
            p2ChessEl.style.color = p2.color;
        }
    };

    const renderChooseFirstPlayerModal = () => {
        const optionsDiv = document.getElementById('first-player-options');
        optionsDiv.innerHTML = ''; // Clear previous options

        Object.keys(appState.game.players).forEach(playerId => {
            const player = appState.game.players[playerId];
            const btn = document.createElement('button');
            btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl';
            btn.textContent = player.name;
            btn.dataset.playerId = playerId;
            optionsDiv.appendChild(btn);
        });

        showModal('chooseFirstPlayerModal');
    };

    const renderIssueWinModal = () => {
        const optionsDiv = document.getElementById('issue-win-options');
        optionsDiv.innerHTML = ''; // Clear previous options

        Object.keys(appState.game.players).forEach(playerId => {
            const player = appState.game.players[playerId];
            const btn = document.createElement('button');
            btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl';
            btn.textContent = player.name;
            btn.dataset.playerId = playerId;
            optionsDiv.appendChild(btn);
        });

        showModal('issueWinModal');
    };

    const renderTimeExpiredModal = () => {
        const optionsDiv = document.getElementById('time-expired-options');
        optionsDiv.innerHTML = ''; // Clear previous options

        Object.keys(appState.game.players).forEach(playerId => {
            const player = appState.game.players[playerId];
            const btn = document.createElement('button');
            btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl';
            btn.textContent = `Award Win to ${player.name}`;
            btn.dataset.playerId = playerId;
            optionsDiv.appendChild(btn);
        });

        const tieBtn = document.createElement('button');
        tieBtn.className = 'w-full bg-gray-500 hover:bg-gray-400 text-white font-bold py-3 px-4 rounded-lg text-xl mt-2';
        tieBtn.textContent = 'Issue a Tie';
        tieBtn.dataset.playerId = 'tie';
        optionsDiv.appendChild(tieBtn);

        showModal('time-expired-modal');
    };

    const showWinnerAnimation = (winner, isRoundWin = false, isTie = false) => {
        const winnerTitle = document.getElementById('winner-title');
        const winnerName = document.getElementById('winner-name');

        if (isTie) {
            winnerTitle.textContent = "TIE!";
            winnerName.textContent = "The round results in a tie!";
        } else if (winner) {
            winnerTitle.textContent = isRoundWin ? "ROUND WINNER!" : "WINNER!";
            winnerName.textContent = isRoundWin ? `${winner.name} wins the round!` : winner.name;
        } else {
            return; // No winner to show
        }
        
        const buttonContainer = document.getElementById('winner-modal-buttons');
        buttonContainer.innerHTML = '';
        if (appState.isHost) {
            const btn = document.createElement('button');
            if (appState.game.gameMode === 'bestOfThree' && !isRoundWin && !isTie) {
                btn.id = 'next-game-btn';
                btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded';
                btn.textContent = 'Next Game';
            } else {
                btn.id = 'play-again-btn';
                btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded';
                btn.textContent = 'Play Again';
            }
            buttonContainer.appendChild(btn);
        } else {
            const closeBtn = document.createElement('button');
            closeBtn.id = 'close-winner-btn';
            closeBtn.className = 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded';
            closeBtn.textContent = 'Close';
            buttonContainer.appendChild(closeBtn);
        }

        showModal('winnerModal');
        appState.winnerAnnounced = true;
    };

    const fullRender = () => {
        renderGameRoom();
        renderPresenter();

        if (appState.game.status === 'finished' && !appState.winnerAnnounced) {
            const winner = appState.game.players[appState.game.roundWinnerId];
            showWinnerAnimation(winner, true, appState.game.isTie);
        } else if (appState.game.status === 'game-over' && !appState.winnerAnnounced) {
            const winner = appState.game.players[appState.game.winnerId];
            showWinnerAnimation(winner, false, false);
        }
    };

    // --- PUSHER LOGIC ---
    const initPusher = () => {
        appState.pusher = new Pusher(PUSHER_APP_KEY, {
            cluster: PUSHER_CLUSTER,
            authEndpoint: '/.netlify/functions/pusher-auth',
            auth: {
                params: {
                    playerName: appState.playerName,
                    isHost: appState.isHost
                }
            }
        });
    };

    const subscribeToChannel = (roomCode) => {
        appState.roomCode = roomCode;
        appState.channel = appState.pusher.subscribe(`presence-tcg-battle-${roomCode}`);

        appState.channel.bind('pusher:subscription_succeeded', (members) => {
            console.log('Subscribed to channel:', roomCode);
            appState.myId = appState.channel.members.me.id;
            
            let wasDemoted = false;
            if (appState.isHost) {
                let anotherHostExists = false;
                members.each(member => {
                    if (member.id !== appState.myId && member.info.isHost) {
                        anotherHostExists = true;
                    }
                });

                if (anotherHostExists) {
                    console.warn("Another host found. Demoting self to guest.");
                    appState.isHost = false;
                    wasDemoted = true;
                    const sessionData = JSON.parse(sessionStorage.getItem('tcgBattleSession'));
                    if (sessionData) {
                        sessionData.isHost = false;
                        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
                    }
                    fullRender();
                }
            }

            if (appState.isHost) {
                console.log("I am the host.");
                if (Object.keys(appState.game.players).length === 0) {
                    appState.game.players[appState.myId] = { name: appState.playerName, prizesTaken: [], isHost: true, color: avatarColors[0], connected: true };
                }
                
                if(appState.game.players[appState.myId]) {
                    appState.game.players[appState.myId].connected = true;
                }

                broadcastGameState();
                fullRender();
            } else {
                console.log("I am a guest, waiting for host state...");
                if (!wasDemoted) {
                    const roomCheckTimeout = setTimeout(() => {
                        let hostExists = false;
                        appState.channel.members.each(member => {
                            if (member.info.isHost) {
                                hostExists = true;
                            }
                        });

                        if (!hostExists) {
                            alert("Room not found or host has left. Returning to home.");
                            sessionStorage.removeItem('tcgBattleSession');
                            window.location.href = window.location.pathname;
                        }
                    }, 3000);

                    appState.roomCheckTimeout = roomCheckTimeout;
                }
            }
            
            if (appState.isHost) {
                bindHostEvents();
            }
        });

        appState.channel.bind('pusher:member_added', (member) => {
            if (appState.isHost && member.id !== appState.myId) {
                console.log('Member added:', member.id);

                const returningPlayerEntry = Object.entries(appState.game.players).find(([id, player]) => player.name === member.info.playerName && !player.connected);

                if (returningPlayerEntry) {
                    console.log('Player is reconnecting...');
                    const [oldId, playerData] = returningPlayerEntry;

                    delete appState.game.players[oldId];

                    appState.game.players[member.id] = {
                        name: playerData.name,
                        prizesTaken: playerData.prizesTaken,
                        isHost: false, // Force guest status on reconnect
                        color: playerData.color,
                        connected: true
                    };
                    
                    if (appState.game.timerType === 'chess') {
                        const oldTime = appState.game.timerState.playerTimes[oldId];
                        if (oldTime !== undefined) {
                            appState.game.timerState.playerTimes[member.id] = oldTime;
                            delete appState.game.timerState.playerTimes[oldId];
                        }
                    }

                    if (appState.game.turn === oldId) {
                        appState.game.turn = member.id;
                    }
                    
                    const allPlayersConnected = Object.values(appState.game.players).every(p => p.connected);
                    if (allPlayersConnected && Object.keys(appState.game.players).length === 2) {
                        appState.game.status = 'active';
                        appState.game.timerState.running = true;
                        startTimer();
                    }
                } else if (Object.keys(appState.game.players).length < 2) {
                    console.log('New player is joining...');
                    appState.game.players[member.id] = {
                        name: member.info.playerName,
                        prizesTaken: [],
                        isHost: false,
                        color: avatarColors[1],
                        connected: true
                    };
                } else {
                    console.log("Spectator/Presenter joined. Not adding to game.");
                }

                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('pusher:member_removed', (member) => {
             if (appState.isHost) {
                console.log('Host saw member removed:', member.id);
                const player = appState.game.players[member.id];
                if (player) {
                    player.connected = false;
                    appState.game.status = 'paused';
                    appState.game.timerState.running = false;
                    broadcastGameState();
                    fullRender();
                }
            } else {
                const removedPlayer = appState.game.players[member.id];
                if (removedPlayer && removedPlayer.isHost) {
                    console.log("Host disconnected. Guest is becoming the new host.");
                    appState.isHost = true;
                    
                    const sessionData = JSON.parse(sessionStorage.getItem('tcgBattleSession'));
                    if (sessionData) {
                        sessionData.isHost = true;
                        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
                    }
                    
                    const myPlayerData = appState.game.players[appState.myId];
                    myPlayerData.isHost = true;
                    myPlayerData.connected = true;

                    removedPlayer.connected = false; 

                    appState.game.status = 'paused';
                    appState.game.timerState.running = false;
                    
                    broadcastGameState();
                    fullRender();
                    bindHostEvents();
                }
            }
        });
        
        appState.channel.bind('client-state-update', (data) => {
            if (!appState.isHost) {
                if (appState.roomCheckTimeout) {
                    console.log("Received host state, cancelling room check timeout.");
                    clearTimeout(appState.roomCheckTimeout);
                    appState.roomCheckTimeout = null;
                }

                console.log('Guest/Presenter received state update:', data);
                appState.game = data;
                
                if (!appState.game.timerState.running && timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                fullRender();
            }
        });
        
        appState.channel.bind('client-session-ended', () => {
            sessionStorage.removeItem('tcgBattleSession');
            localStorage.removeItem(`tcgBattleState-${appState.roomCode}`);
            alert('The host has ended the session.');
            window.location.href = window.location.pathname;
        });
    };

    const broadcastGameState = () => {
        if (!appState.channel || !appState.isHost) return;
        try {
            localStorage.setItem(`tcgBattleState-${appState.roomCode}`, JSON.stringify(appState.game));
            appState.channel.trigger('client-state-update', appState.game);
        } catch (error) {
            console.error("Pusher trigger failed:", error);
        }
    };

    const handleGameWin = (winnerId) => {
        if (!appState.isHost) return;
        
        appState.game.winnerId = winnerId;
        
        if (appState.game.gameMode === 'bestOfThree') {
            appState.game.wins[winnerId] = (appState.game.wins[winnerId] || 0) + 1;
            
            if (appState.game.wins[winnerId] >= 2) {
                appState.game.roundWinnerId = winnerId;
                appState.game.status = 'finished';
                appState.game.timerState.running = false;
            } else {
                appState.game.status = 'game-over'; // Intermediate state
            }
        } else {
            appState.game.roundWinnerId = winnerId;
            appState.game.status = 'finished';
            appState.game.timerState.running = false;
        }
        
        playBuzzer();
        broadcastGameState();
        fullRender();
    };

    const handleScoop = (loserId) => {
        const winnerId = Object.keys(appState.game.players).find(id => id !== loserId);
        if (!winnerId) return;
        handleGameWin(winnerId);
    };

    const handleIssueWin = (winnerId) => {
        if (!appState.isHost) return;
        handleGameWin(winnerId);
    };

    const bindHostEvents = () => {
        if (!appState.channel) return;

        appState.channel.unbind('client-update-prizes');
        appState.channel.unbind('client-end-turn');
        appState.channel.unbind('client-scoop-game');

        appState.channel.bind('client-update-prizes', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].prizesTaken = data.prizes;
                
                if (data.prizes.length >= appState.game.prizeCount) {
                    handleGameWin(playerId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            }
        });

        appState.channel.bind('client-end-turn', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.turn === playerId) {
                appState.game.turn = data.turn;
                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('client-scoop-game', (data, metadata) => {
            handleScoop(metadata.user_id);
        });

        console.log("Host events have been successfully bound.");
    };
    
    let timerInterval;
    const startTimer = () => {
        if (timerInterval) clearInterval(timerInterval);
        if (!appState.game.timerState.running || !appState.isHost) return;

        let lastTick = Date.now();
        timerInterval = setInterval(() => {
            if (!appState.game.timerState.running) {
                clearInterval(timerInterval);
                timerInterval = null;
                return;
            }
            const delta = Date.now() - lastTick;
            lastTick = Date.now();
            
            const { timerType, turn } = appState.game;
            if (timerType === 'countdown') {
                appState.game.timerState.elapsed += delta;
                if ((appState.game.countdownMinutes * 60 * 1000) - appState.game.timerState.elapsed <= 0) {
                    appState.game.timerState.running = false;
                    playBuzzer();
                    if (appState.game.gameMode === 'bestOfThree') {
                        renderTimeExpiredModal();
                    } else {
                        // Handle basic swiss timeout if needed
                    }
                }
            } else {
                if (turn && appState.game.timerState.playerTimes[turn]) {
                    appState.game.timerState.playerTimes[turn] -= delta;
                    if (appState.game.timerState.playerTimes[turn] <= 0) {
                        appState.game.timerState.playerTimes[turn] = 0;
                        appState.game.timerState.running = false;
                        playBuzzer();
                    }
                }
            }
            
            broadcastGameState();
            fullRender();
        }, 1000);
    };

    const startGameWithFirstPlayer = (firstPlayerId) => {
        if (!appState.isHost) return;

        appState.game.status = 'active';
        appState.game.timerState.running = true;
        appState.game.timerState.startTime = Date.now();
        appState.game.elapsed = 0;
        appState.game.turn = firstPlayerId;
        
        Object.keys(appState.game.players).forEach(id => {
            if (!appState.game.wins[id]) {
                appState.game.wins[id] = 0;
            }
        });

        if (appState.game.timerType === 'chess') {
            Object.keys(appState.game.players).forEach(id => {
                appState.game.timerState.playerTimes[id] = appState.game.chessMinutes * 60 * 1000;
            });
        }

        broadcastGameState();
        startTimer();
        fullRender();
    };

    const playBuzzer = () => {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
            gainNode.gain.setValueAtTime(1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 1);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        } catch (e) { console.error("Could not play buzzer sound:", e); }
    };

    // --- EVENT HANDLERS ---
    document.getElementById('create-session-btn').addEventListener('click', () => showView('tcgSelection'));
    document.getElementById('join-session-btn').addEventListener('click', () => {
        document.getElementById('join-player-name').value = appState.playerName;
        showModal('joinSessionModal');
    });
    document.getElementById('back-to-home-from-tcg').addEventListener('click', () => showView('home'));
    document.getElementById('select-pokemon').addEventListener('click', () => {
        document.getElementById('player-name-input').value = appState.playerName;
        showModal('gameSettingsModal');
        const isCountdown = appState.game.timerType === 'countdown';
        document.getElementById('countdown-timer-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('number-of-games-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('chess-timer-settings').style.display = isCountdown ? 'none' : 'block';
    });
    document.querySelectorAll('.prize-option-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.prize-option-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.prizeCount = parseInt(btn.dataset.prizes);
    }));
    document.querySelectorAll('.timer-type-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.timer-type-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.timerType = btn.dataset.timer;
        const isCountdown = appState.game.timerType === 'countdown';
        document.getElementById('countdown-timer-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('number-of-games-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('chess-timer-settings').style.display = isCountdown ? 'none' : 'block';
        if (!isCountdown) {
            appState.game.gameMode = 'basic';
        }
    }));
    document.querySelectorAll('.game-mode-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.game-mode-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.gameMode = btn.dataset.mode;
    }));
    document.getElementById('cancel-settings-btn').addEventListener('click', () => hideModal('gameSettingsModal'));
    document.getElementById('cancel-join-btn').addEventListener('click', () => hideModal('joinSessionModal'));
    
    document.getElementById('confirm-create-btn').addEventListener('click', () => {
        appState.playerName = document.getElementById('player-name-input').value || appState.playerName;
        appState.game.countdownMinutes = parseInt(document.getElementById('countdown-minutes').value) || 30;
        appState.game.chessMinutes = parseInt(document.getElementById('chess-minutes').value) || 20;

        const sessionData = {
            roomCode: generateRoomCode(),
            isHost: true,
            playerName: appState.playerName,
            view: 'gameRoom',
            game: appState.game
        };
        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
        init();
    });

    document.getElementById('confirm-join-btn').addEventListener('click', () => {
        const roomCode = document.getElementById('room-code-input').value;
        const playerName = document.getElementById('join-player-name').value;
        if (!roomCode || roomCode.length !== 5 || !playerName) {
            console.error('Please enter a valid name and 5-digit room code.');
            return;
        }
        const sessionData = {
            roomCode: roomCode,
            isHost: false,
            playerName: playerName,
            view: 'gameRoom'
        };
        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
        init();
    });
    document.getElementById('prize-card-grid').addEventListener('click', (e) => {
        if (e.target.classList.contains('prize-card') && appState.game.status === 'active') {
            const prizeId = parseInt(e.target.dataset.prizeId);
            const myPlayer = appState.game.players[appState.myId];
            if (!myPlayer) return;
            const myPrizes = myPlayer.prizesTaken;
            if (myPrizes.includes(prizeId)) {
                myPrizes.splice(myPrizes.indexOf(prizeId), 1);
            } else {
                myPrizes.push(prizeId);
            }
            
            if (appState.isHost) {
                if (myPrizes.length >= appState.game.prizeCount) {
                    handleGameWin(appState.myId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            } else {
                appState.channel.trigger('client-update-prizes', { prizes: myPrizes });
            }
        }
    });
    
    document.getElementById('game-menu-dropdown').addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = e.target.id;

        if (targetId === 'start-game-btn') {
            const pIds = Object.keys(appState.game.players);
            if (pIds.length < 2) {
                console.error("Cannot start, waiting for a guest to join.");
                return;
            }
            renderChooseFirstPlayerModal();
        } else if (targetId === 'restart-round-btn') {
            restartRound();
        } else if (targetId === 'issue-win-btn') {
            renderIssueWinModal();
        } else if (targetId === 'kick-guest-btn') {
            const guestId = Object.keys(appState.game.players).find(id => !appState.game.players[id].isHost);
            if(guestId) {
                appState.channel.trigger('client-player-leave', {id: guestId});
                delete appState.game.players[guestId];
                broadcastGameState();
            }
        } else if (targetId === 'end-session-btn') {
            appState.channel.trigger('client-session-ended', {});
            setTimeout(() => {
                sessionStorage.removeItem('tcgBattleSession');
                localStorage.removeItem(`tcgBattleState-${appState.roomCode}`);
                window.location.href = window.location.pathname;
            }, 500);
        } else if (targetId === 'leave-battle-btn') {
            sessionStorage.removeItem('tcgBattleSession');
            window.location.href = window.location.pathname;
        }

        document.getElementById('game-menu-dropdown').classList.add('hidden');
    });

    document.getElementById('game-menu-btn').addEventListener('click', () => {
        document.getElementById('game-menu-dropdown').classList.toggle('hidden');
    });

    document.getElementById('first-player-options').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const firstPlayerId = e.target.dataset.playerId;
            if (firstPlayerId) {
                hideModal('chooseFirstPlayerModal');
                startGameWithFirstPlayer(firstPlayerId);
            }
        }
    });

    document.getElementById('issue-win-options').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const winnerId = e.target.dataset.playerId;
            if (winnerId) {
                hideModal('issueWinModal');
                handleIssueWin(winnerId);
            }
        }
    });

    document.getElementById('cancel-issue-win-btn').addEventListener('click', () => hideModal('issueWinModal'));

    document.getElementById('time-expired-options').addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const decision = e.target.dataset.playerId;
        hideModal('time-expired-modal');

        const pIds = Object.keys(appState.game.players);
        const p1Id = pIds[0];
        const p2Id = pIds[1];
        const p1Wins = appState.game.wins[p1Id] || 0;
        const p2Wins = appState.game.wins[p2Id] || 0;

        if (decision === 'tie') {
            if (p1Wins > p2Wins) appState.game.roundWinnerId = p1Id;
            else if (p2Wins > p1Wins) appState.game.roundWinnerId = p2Id;
            else appState.game.isTie = true;
        } else {
            const awardedWinnerId = decision;
            const currentWins = appState.game.wins[awardedWinnerId] || 0;
            const opponentId = pIds.find(id => id !== awardedWinnerId);
            const opponentWins = appState.game.wins[opponentId] || 0;

            if (currentWins + 1 >= 2) {
                appState.game.roundWinnerId = awardedWinnerId;
            } else if (currentWins === 0 && opponentWins === 0) {
                appState.game.roundWinnerId = awardedWinnerId;
            } else {
                appState.game.isTie = true;
            }
        }
        
        appState.game.status = 'finished';
        broadcastGameState();
        fullRender();
    });

    const startNextGame = () => {
        Object.values(appState.game.players).forEach(p => p.prizesTaken = []);
        appState.game.status = 'active';
        appState.game.currentGame++;
        appState.winnerAnnounced = false;
        appState.game.winnerId = null;
        hideModal('winnerModal');
        broadcastGameState();
        fullRender();
    };

    const restartRound = () => {
        Object.values(appState.game.players).forEach(p => p.prizesTaken = []);
        appState.game.status = 'waiting';
        appState.game.timerState = { running: false, startTime: null, elapsed: 0, playerTimes: {} };
        appState.game.wins = {};
        appState.game.currentGame = 1;
        appState.game.roundWinnerId = null;
        appState.game.isTie = false;
        appState.game.winnerId = null;
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        appState.winnerAnnounced = false;
        hideModal('winnerModal');
        broadcastGameState();
        fullRender();
    };

    document.getElementById('winner-modal-buttons').addEventListener('click', (e) => {
        if (e.target.id === 'play-again-btn' && appState.isHost) {
            restartRound();
        } else if (e.target.id === 'next-game-btn' && appState.isHost) {
            startNextGame();
        } else if (e.target.id === 'close-winner-btn' && !appState.isHost) {
            hideModal('winnerModal');
        }
    });

    document.body.addEventListener('click', (e) => {
        if (e.target.id === 'end-turn-btn') {
            const pIds = Object.keys(appState.game.players);
            const myId = appState.myId;
            const otherPlayerId = pIds.find(id => id !== myId);
            
            if (appState.isHost) {
                appState.game.turn = otherPlayerId;
                broadcastGameState();
                fullRender();
            } else {
                appState.channel.trigger('client-end-turn', { turn: otherPlayerId });
            }
        }
        if (e.target.id === 'scoop-btn') {
            if (appState.isHost) {
                handleScoop(appState.myId);
            } else {
                appState.channel.trigger('client-scoop-game', {});
            }
        }
        if (document.getElementById('game-menu-dropdown') && !document.getElementById('game-menu-btn').contains(e.target) && !document.getElementById('game-menu-dropdown').contains(e.target)) {
            document.getElementById('game-menu-dropdown').classList.add('hidden');
        }
    });
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    fullscreenBtn.addEventListener('click', () => {
        const elem = document.documentElement;
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    });

    // --- INITIALIZATION ---
    const init = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const presenterCode = urlParams.get('presenter');
        const roomToJoin = urlParams.get('join');
        const savedSession = sessionStorage.getItem('tcgBattleSession');

        if (savedSession) {
            const sessionData = JSON.parse(savedSession);
            appState.roomCode = sessionData.roomCode;
            appState.isHost = sessionData.isHost;
            appState.playerName = sessionData.playerName;
            
            if (sessionData.isHost) {
                const savedGameState = localStorage.getItem(`tcgBattleState-${appState.roomCode}`);
                if (savedGameState) {
                    appState.game = JSON.parse(savedGameState);
                }
            }
            
            initPusher();
            subscribeToChannel(appState.roomCode);
            showView(sessionData.view);
            fullRender();

        } else if (presenterCode) {
            appState.isHost = false;
            appState.myId = `presenter_${Date.now()}`;
            initPusher();
            subscribeToChannel(presenterCode);
            showView('presenter');
        } else if (roomToJoin) {
            document.getElementById('room-code-input').value = roomToJoin;
            showModal('joinSessionModal');
            showView('home');
        } else {
            showView('home');
        }
    };

    init();
});
</script>

</body>
</html>
