<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCG Battle!</title>
    <link rel="icon" type="image/png" href="https://tcgbattle.netlify.app/images/tcg_battle_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-bangers { font-family: 'Bangers', cursive; }
        .logo-text { text-shadow: 4px 4px 0px #1f2937, -2px -2px 0 #1f2937, 2px -2px 0 #1f2937, -2px 2px 0 #1f2937, 2px 2px 0 #1f2937; }
        .disabled-card { filter: grayscale(100%); cursor: not-allowed; }
        .prize-card { transition: all 0.3s ease; border: 2px solid #6b7280; }
        .prize-card.taken {  
            background-color: #4b5563 !important;  
            color: #9ca3af !important;  
            transform: scale(0.95);  
            border-color: #374151;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .turn-indicator-glow { box-shadow: 0 0 15px 4px #22c55e; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 15px 4px #22c55e; } 70% { box-shadow: 0 0 20px 6px #16a34a; } 100% { box-shadow: 0 0 15px 4px #22c55e; } }
        .modal-backdrop { background-color: rgba(0,0,0,0.75); }

        /* Presenter Styles */
        .presenter-prize-container {
            position: relative;
            width: 450px; 
            height: 450px;
        }
        .presenter-prize-pokeball {
            position: absolute;
            left: 50%;
            top: 50%;
            margin: -32px; 
            width: 64px;   
            height: 64px;  
            border-radius: 50%;
            background: linear-gradient(to bottom, #ef4444 0%, #ef4444 50%, #f9fafb 50%, #f9fafb 100%);
            border: 3px solid #1f2937; 
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .presenter-prize-pokeball::before {
            content: '';
            position: absolute;
            height: 8px; 
            width: 100%;
            background: #1f2937;
        }
        .presenter-prize-pokeball::after {
            content: '';
            position: absolute;
            height: 22px; 
            width: 22px;  
            border-radius: 50%;
            background: #f9fafb;
            border: 5px solid #1f2937; 
        }
        .presenter-prize-pokeball.taken {
            filter: grayscale(100%);
        }
        
        /* Winner Animation */
        @keyframes winner-pop {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .winner-animation {
            animation: winner-pop 0.5s ease-out forwards;
        }

        /* Lorcana Styles */
        .lore-icon-glow {
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8));
        }

        /* Additional Tracking Styles */
        .action-btn.used {
            opacity: 0.4;
            transform: scale(0.95);
        }
        .presenter-action-emblem {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            color: white;
            border: 2px solid #9ca3af;
            transition: all 0.3s ease;
        }
        .presenter-action-emblem.used {
            opacity: 0.3;
            filter: grayscale(80%);
        }
        
        /* MTG D20 Styles */
        .d20-life-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto;
        }
        .d20-life-bg {
            width: 100%;
            height: 100%;
        }
        .d20-life-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Bangers', cursive;
            font-size: 56px;
            color: #FFFFFF;
            text-shadow: 2px 2px 4px #000000;
        }

        /* Pokemon Tile Style */
        .pokeball-tile {
            position: relative;
            width: 96px;
            height: 96px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #ef4444 0%, #ef4444 50%, #f9fafb 50%, #f9fafb 100%);
            border: 4px solid #1f2937;
            margin: 0 auto 8px auto;
            transition: all 0.3s ease;
        }
        .pokeball-tile::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            height: 6px;
            width: 100%;
            background: #1f2937;
        }
        .pokeball-tile::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #f9fafb;
            border: 5px solid #1f2937;
        }

        /* Calculator Styles */
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        .calculator-btn {
            background-color: #4b5563;
            border: 1px solid #6b7280;
        }
        .calculator-btn:hover {
            background-color: #6b7280;
        }
        .calculator-display {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            min-height: 60px;
        }
    </style>
</head>
<body class="text-gray-100" style="background-color: #1a1a2e;">

    <div id="app" class="relative min-h-screen">

        <section id="home-view" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
            <div class="mb-8 w-full max-w-lg">
                <img src="https://tcgbattle.netlify.app/images/tcg_battle_logo.png" alt="TCG Battle Logo" class="w-full h-auto">
            </div>
            <div class="space-y-4 w-full max-w-xs">
                <button id="create-session-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Create a new battle</button>
                <button id="join-session-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Join an existing battle</button>
            </div>
            <div class="absolute bottom-4 text-xs text-gray-500">
                <p>This app is under active development. Expect bugs and glitches.</p>
            </div>
        </section>

        <section id="tcg-selection-view" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
            <h2 class="text-4xl font-bold mb-8">Choose Your TCG</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-2xl">
                <div id="select-pokemon" class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer border-2 border-transparent hover:border-yellow-400 hover:bg-gray-600 transition-colors">
                    <div class="pokeball-tile"></div>
                    <h3 class="font-bold text-lg">Pok√©mon</h3>
                </div>
                <div id="select-lorcana" class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer border-2 border-transparent hover:border-purple-400 hover:bg-gray-600 transition-colors">
                    <img src="https://tcgbattle.netlify.app/images/lore.png" alt="Lorcana" class="h-24 mx-auto mb-2" onerror="this.onerror=null;this.src='https://placehold.co/150x100/78716C/FFFFFF?text=Lorcana';">
                    <h3 class="font-bold text-lg">Lorcana</h3>
                </div>
                <div id="select-mtg" class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer border-2 border-transparent hover:border-red-500 hover:bg-gray-600 transition-colors">
                    <img src="https://tcgbattle.netlify.app/images/d20_white.png" alt="Magic: The Gathering" class="h-24 mx-auto mb-2" onerror="this.onerror=null;this.src='https://placehold.co/150x100/78716C/FFFFFF?text=MTG';">
                    <h3 class="font-bold text-lg">MTG</h3>
                </div>
                <div id="select-yugioh" class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer border-2 border-transparent hover:border-yellow-300 hover:bg-gray-600 transition-colors">
                    <img src="https://tcgbattle.netlify.app/images/yugioh.png" alt="Yu-Gi-Oh!" class="h-24 mx-auto mb-2" onerror="this.onerror=null;this.src='https://placehold.co/150x100/78716C/FFFFFF?text=YGO';">
                    <h3 class="font-bold text-lg">Yu-Gi-Oh!</h3>
                </div>
                <div id="select-onepiece" class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer border-2 border-transparent hover:border-blue-400 hover:bg-gray-600 transition-colors">
                     <svg class="h-24 w-24 mx-auto mb-2 text-white" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="10"/>
                        <line x1="25" y1="25" x2="75" y2="75" stroke="currentColor" stroke-width="10" stroke-linecap="round"/>
                        <line x1="75" y1="25" x2="25" y2="75" stroke="currentColor" stroke-width="10" stroke-linecap="round"/>
                    </svg>
                    <h3 class="font-bold text-lg">One Piece</h3>
                </div>
                 <div class="bg-gray-700 p-4 rounded-lg text-center disabled-card relative flex flex-col justify-center items-center">
                    <h3 class="font-bold text-lg text-gray-400">Dragonball Z</h3>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 px-2 py-1 rounded text-sm">In Development</span>
                </div>
            </div>
             <button id="back-to-home-from-tcg" class="mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Back</button>
        </section>

        <div id="game-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Game Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold">Player Name</label>
                        <input type="text" id="player-name-input" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="Enter your name">
                    </div>
                    <div id="prize-card-settings" class="hidden">
                        <label class="font-bold">Prize Cards</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-prizes="6" class="prize-option-btn flex-1 bg-blue-600 text-white rounded p-2">6 (Standard)</button>
                            <button data-prizes="4" class="prize-option-btn flex-1 bg-gray-600 text-white rounded p-2">4 (Pre-Release)</button>
                        </div>
                    </div>
                    <div id="additional-tracking-settings" class="hidden">
                        <label class="font-bold flex items-center">
                            Additional Tracking
                            <span class="text-xs text-gray-400 ml-2 font-normal">e.g. Supporter, Energy, Retreat, Stadium</span>
                        </label>
                        <div class="flex space-x-2 mt-1">
                            <button data-tracking="false" class="tracking-option-btn flex-1 bg-blue-600 text-white rounded p-2">Disable</button>
                            <button data-tracking="true" class="tracking-option-btn flex-1 bg-gray-600 text-white rounded p-2">Enable</button>
                        </div>
                    </div>
                    <div id="lorcana-lore-settings" class="hidden">
                        <label class="font-bold">Lore to Win</label>
                        <input type="number" id="lore-to-win-input" value="20" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="mtg-life-settings" class="hidden">
                        <label class="font-bold">Starting Life</label>
                        <input type="number" id="starting-life-input" value="20" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="yugioh-lp-settings" class="hidden">
                        <label class="font-bold">Starting Life Points</label>
                        <input type="number" id="starting-lp-input" value="8000" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="onepiece-settings" class="hidden">
                         <label class="font-bold">DON!! Tracker</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-don="false" class="don-option-btn flex-1 bg-blue-600 text-white rounded p-2">Disable</button>
                            <button data-don="true" class="don-option-btn flex-1 bg-gray-600 text-white rounded p-2">Enable</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-bold">Timer Type</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-timer="countdown" class="timer-type-btn flex-1 bg-blue-600 text-white rounded p-2">Countdown</button>
                            <button data-timer="chess" class="timer-type-btn flex-1 bg-gray-600 text-white rounded p-2">Chess Clock</button>
                        </div>
                    </div>
                    <div id="countdown-timer-settings">
                        <label class="font-bold">Round Time (minutes)</label>
                        <input type="number" id="countdown-minutes" value="30" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="chess-timer-settings" class="hidden">
                        <label class="font-bold">Time Per Player (minutes)</label>
                        <input type="number" id="chess-minutes" value="20" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1">
                    </div>
                    <div id="number-of-games-settings">
                        <label class="font-bold">Number of Games</label>
                        <div class="flex space-x-2 mt-1">
                            <button data-mode="basic" class="game-mode-btn flex-1 bg-blue-600 text-white rounded p-2">Basic Swiss</button>
                            <button data-mode="bestOfThree" class="game-mode-btn flex-1 bg-gray-600 text-white rounded p-2">Best-of-Three</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-settings-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    <button id="confirm-create-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Create Battle</button>
                </div>
            </div>
        </div>
        
        <div id="join-session-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Join Battle</h2>
                <div class="space-y-4">
                    <div>
                        <label class="font-bold">Your Name</label>
                        <input type="text" id="join-player-name" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1" placeholder="Enter your name">
                    </div>
                    <div>
                        <label class="font-bold">5-Digit Room Code</label>
                        <input type="text" id="room-code-input" maxlength="5" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-1 text-center text-2xl tracking-widest" placeholder="_ _ _ _ _">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-join-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
                    <button id="confirm-join-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Join</button>
                </div>
            </div>
        </div>

        <div id="choose-first-player-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">Who Goes First?</h2>
                <div id="first-player-options" class="space-y-3">
                </div>
            </div>
        </div>

        <div id="set-starting-life-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">Set Your Leader's Life</h2>
                <input type="number" id="player-starting-life-input" value="5" class="w-full bg-gray-800 border border-gray-600 rounded p-2 mt-2 text-center text-2xl">
                <button id="submit-starting-life-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl">Submit</button>
                <p id="waiting-for-life-submission" class="text-gray-400 mt-4 hidden">Waiting for opponent...</p>
            </div>
        </div>

        <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div id="winner-card" class="bg-gray-700 rounded-lg p-8 w-full max-w-md text-center winner-animation">
                <i class="fas fa-trophy text-yellow-400 text-6xl mb-4"></i>
                <h2 id="winner-title" class="text-4xl font-bold mb-2">WINNER!</h2>
                <p id="winner-name" class="text-3xl font-bangers tracking-wider"></p>
                <div id="winner-modal-buttons" class="mt-6">
                </div>
            </div>
        </div>

        <div id="issue-win-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">End Game</h2>
                <div id="issue-win-options" class="space-y-3"></div>
                <button id="cancel-issue-win-btn" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">Cancel</button>
            </div>
        </div>

        <div id="zero-life-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-700 rounded-lg p-6 w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-4">Player at 0 Life</h2>
                <p id="zero-life-prompt" class="mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="zero-life-no-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">No</button>
                    <button id="zero-life-yes-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Yes</button>
                </div>
            </div>
        </div>

        <div id="calculator-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg p-4 w-full max-w-xs shadow-xl">
                <div id="calculator-display" class="calculator-display rounded p-2 mb-4 text-right text-3xl font-mono text-white break-words">0</div>
                <div id="calculator-buttons" class="calculator-grid"></div>
                <button id="close-calculator-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>

        <section id="game-room-view" class="hidden min-h-screen flex flex-col p-2 sm:p-4">
            <header class="flex justify-between items-center mb-4">
                <div class="text-sm">
                    <p>Room: <span id="room-code-display" class="font-bold tracking-wider"></span></p>
                    <p id="player-role" class="font-bold"></p>
                </div>
                <div class="text-center">
                    <img src="https://tcgbattle.netlify.app/images/tcg_battle_logo.png" alt="TCG Battle Logo" class="h-10 mx-auto">
                </div>
                <div class="relative">
                    <button id="game-menu-btn" class="p-2"><i class="fas fa-bars fa-lg"></i></button>
                    <div id="game-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 rounded-md shadow-lg z-20">
                    </div>
                </div>
            </header>

            <main class="flex-grow flex flex-col items-center justify-center">
                <div id="waiting-for-opponent" class="text-center">
                    <h2 class="text-2xl font-bold">Waiting for opponent...</h2>
                    <p class="text-gray-400">Share the room code to let them join.</p>
                </div>

                <div id="game-controls" class="hidden w-full max-w-lg text-center">
                    <div id="game-status-info" class="mb-4 py-6 px-3 bg-gray-900 rounded-lg">
                         <p id="game-status-text" class="text-xl font-bold text-yellow-400"></p>
                         <div id="player-turn-info" class="flex justify-around items-center mt-4 px-4">
                             <div id="player1-turn-indicator" class="p-2 rounded-lg">
                                 <p id="player1-name-turn" class="font-bold"></p>
                             </div>
                             <div id="player2-turn-indicator" class="p-2 rounded-lg">
                                 <p id="player2-name-turn" class="font-bold"></p>
                             </div>
                         </div>
                    </div>
                    
                    <div id="timer-display-controls" class="mb-4 text-center"></div>
                    
                    <div id="pokemon-controls" class="hidden">
                        <div id="additional-tracking-buttons" class="hidden grid grid-cols-4 gap-2 mb-4">
                            <button data-action="supporter" class="action-btn bg-blue-500 hover:bg-blue-600 rounded p-2 font-bold transition-all">Supporter</button>
                            <button data-action="energy" class="action-btn bg-yellow-500 hover:bg-yellow-600 rounded p-2 font-bold transition-all">Energy</button>
                            <button data-action="retreat" class="action-btn bg-green-500 hover:bg-green-600 rounded p-2 font-bold transition-all">Retreat</button>
                            <button data-action="stadium" class="action-btn bg-purple-500 hover:bg-purple-600 rounded p-2 font-bold transition-all">Stadium</button>
                        </div>
                        <h3 class="font-bold text-xl mb-2">Your Prize Cards</h3>
                        <div id="prize-card-grid" class="grid grid-cols-2 gap-3">
                        </div>
                    </div>

                    <div id="lorcana-controls" class="hidden">
                        <h3 class="font-bold text-xl mb-2">Your Lore</h3>
                        <div id="lore-tracker" class="flex flex-col items-center">
                        </div>
                    </div>
                    
                    <div id="mtg-controls" class="hidden">
                        <h3 class="font-bold text-xl mb-2">Your Life</h3>
                        <div id="life-tracker" class="flex flex-col items-center">
                        </div>
                    </div>

                    <div id="yugioh-controls" class="hidden">
                        <h3 class="font-bold text-xl mb-2">Your Life Points</h3>
                        <div id="lp-tracker" class="flex flex-col items-center">
                        </div>
                    </div>

                    <div id="onepiece-controls" class="hidden">
                         <div id="onepiece-life-tracker" class="mb-4">
                            <h3 class="font-bold text-xl mb-2">Your Life</h3>
                            <!-- Life controls here -->
                         </div>
                         <div id="don-tracker" class="hidden">
                            <h3 class="font-bold text-xl mb-2">DON!!</h3>
                            <!-- DON!! controls here -->
                         </div>
                         <button id="final-attack-btn" class="hidden mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-2xl">Final Attack!</button>
                    </div>
                    
                    <div id="turn-controls" class="mt-4">
                    </div>
                </div>
            </main>
        </section>

        <section id="presenter-view" class="hidden min-h-screen flex flex-col items-center justify-center p-4" style="background-color: #000000;">
            <div id="presenter-board" class="w-full max-w-7xl mx-auto relative">
                <div class="flex justify-between items-center">
                    <div id="presenter-p1-side" class="flex-1 flex flex-col items-center">
                        <div id="presenter-p1-avatar" class="w-32 h-32 md:w-48 md:h-48 p-2 rounded-lg bg-black bg-opacity-20 border-2 border-gray-500"></div>
                        <h2 id="presenter-p1-name" class="mt-2 text-2xl md:text-4xl font-bold text-white bg-black bg-opacity-20 px-4 py-1 rounded-md">Player 1</h2>
                        <div id="presenter-p1-actions" class="hidden mt-2 space-x-2"></div>
                        <p id="presenter-p1-wins" class="text-xl font-bold text-yellow-400 mt-2"></p>
                        <div id="presenter-p1-lore" class="flex items-center text-3xl font-bold mt-2 hidden"></div>
                        <div id="presenter-p1-life" class="text-3xl font-bold mt-2 hidden"></div>
                        <div id="presenter-p1-lp" class="text-3xl font-bold mt-2 hidden"></div>
                    </div>
                    
                    <div class="flex-shrink-0 mx-8">
                        <img src="https://tcgbattle.netlify.app/images/tcg_battle_logo.png" alt="TCG Battle Logo" class="w-64 md:w-80">
                        <p id="presenter-game-number" class="text-center text-3xl font-bold text-white mt-4"></p>
                    </div>

                    <div id="presenter-p2-side" class="flex-1 flex flex-col items-center">
                        <div id="presenter-p2-avatar" class="w-32 h-32 md:w-48 md:h-48 p-2 rounded-lg bg-black bg-opacity-20 border-2 border-gray-500"></div>
                        <h2 id="presenter-p2-name" class="mt-2 text-2xl md:text-4xl font-bold text-white bg-black bg-opacity-20 px-4 py-1 rounded-md">Player 2</h2>
                        <div id="presenter-p2-actions" class="hidden mt-2 space-x-2"></div>
                        <p id="presenter-p2-wins" class="text-xl font-bold text-yellow-400 mt-2"></p>
                        <div id="presenter-p2-lore" class="flex items-center text-3xl font-bold mt-2 hidden"></div>
                        <div id="presenter-p2-life" class="text-3xl font-bold mt-2 hidden"></div>
                        <div id="presenter-p2-lp" class="text-3xl font-bold mt-2 hidden"></div>
                    </div>
                </div>

                <div id="presenter-p1-prizes" class="presenter-prize-container absolute left-0 top-1/2 -translate-y-1/2"></div>
                <div id="presenter-p2-prizes" class="presenter-prize-container absolute right-0 top-1/2 -translate-y-1/2"></div>
                
                 <div id="presenter-timer-container" class="absolute bottom-[-80px] left-1/2 -translate-x-1/2 bg-black rounded-lg px-6 py-2 border-2 border-gray-600">
                     <div id="presenter-timer" class="text-5xl md:text-6xl font-mono font-bold tabular-nums text-yellow-300">00:00</div>
                     <div id="presenter-chess-timers" class="hidden w-full flex justify-around gap-8 text-4xl md:text-5xl font-mono font-bold tabular-nums">
                         <div id="presenter-chess-p1">00:00</div>
                         <div id="presenter-chess-p2">00:00</div>
                     </div>
                 </div>
            </div>
            <div class="absolute top-4 right-4 text-sm text-gray-300">Room: <span id="presenter-room-code" class="font-bold"></span></div>
            <button id="fullscreen-btn" class="absolute top-4 left-4 text-white bg-black bg-opacity-25 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-50">
                <i class="fas fa-expand"></i>
            </button>
        </section>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let appState = {
        pusher: null,
        channel: null,
        myId: null,
        isHost: false,
        roomCode: null,
        view: 'home', // home, tcgSelection, gameRoom, presenter
        playerName: `Player${Math.floor(Math.random() * 900 + 100)}`,
        winnerAnnounced: false, // Client-side flag
        game: {
            tcg: 'pokemon',
            status: 'waiting', // waiting, active, paused, finished, overtime, game-over, setting_life
            prizeCount: 6,
            loreToWin: 20,
            startingLife: 20,
            startingLP: 8000,
            donTrackerEnabled: false,
            timerType: 'countdown', // countdown, chess
            countdownMinutes: 30,
            chessMinutes: 20,
            gameMode: 'basic', // basic, bestOfThree
            additionalTrackingEnabled: false,
            currentGame: 1,
            wins: {}, // { [playerId]: winCount }
            roundWinnerId: null,
            isTie: false,
            winnerId: null,
            players: {}, // { [id]: { name, prizesTaken, loreCount, life, lp, don, isHost, color, connected, actionsUsed, lifeSubmitted } }
            turn: null, // player id
            timerState: {
                running: false,
                startTime: null,
                elapsed: 0,
                playerTimes: {} // { [id]: timeInMillis }
            }
        },
    };

// --- PUSHER CONFIGURATION ---
let PUSHER_APP_KEY = null;
let PUSHER_CLUSTER = null;

    // --- DOM ELEMENTS ---
    const views = {
        home: document.getElementById('home-view'),
        tcgSelection: document.getElementById('tcg-selection-view'),
        gameSettingsModal: document.getElementById('game-settings-modal'),
        joinSessionModal: document.getElementById('join-session-modal'),
        gameRoom: document.getElementById('game-room-view'),
        presenter: document.getElementById('presenter-view'),
        chooseFirstPlayerModal: document.getElementById('choose-first-player-modal'),
        setStartingLifeModal: document.getElementById('set-starting-life-modal'),
        winnerModal: document.getElementById('winner-modal'),
        issueWinModal: document.getElementById('issue-win-modal'),
        zeroLifeModal: document.getElementById('zero-life-modal'),
        calculatorModal: document.getElementById('calculator-modal'),
    };
    
    // --- ASSETS ---
    const trainerSilhouetteSVG = `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
    const avatarColors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#8b5cf6', '#ec4899', '#f97316'];
    const loreIconSVG = `<svg class="w-20 h-20 text-gray-200 lore-icon-glow" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12.0001 2.40039L18.4001 12.0004L12.0001 21.6004L5.6001 12.0004L12.0001 2.40039ZM12.0001 7.68039L9.1201 12.0004L12.0001 16.3204L14.8801 12.0004L12.0001 7.68039Z"/></svg>`;

    // --- UTILITY FUNCTIONS ---
    const generateRoomCode = () => Math.floor(10000 + Math.random() * 90000).toString();
    const formatTime = (ms) => {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    };
    const createPlayerObject = (name, isHost, color) => ({
        name,
        isHost,
        color,
        prizesTaken: [],
        loreCount: 0,
        life: 5, // Default for One Piece, will be updated
        lp: appState.game.startingLP,
        don: { active: 0, rested: 0 },
        connected: true,
        actionsUsed: { supporter: false, energy: false, retreat: false, stadium: false },
        lifeSubmitted: false
    });


    // --- VIEW MANAGEMENT ---
    const showView = (viewName) => {
        appState.view = viewName;
        Object.keys(views).forEach(key => {
            if (views[key]) {
                 views[key].classList.add('hidden');
            }
        });
        if (views[viewName]) {
            views[viewName].classList.remove('hidden');
        }
    };
    
    const showModal = (modalName) => {
        if (views[modalName]) views[modalName].classList.remove('hidden');
    };
    
    const hideModal = (modalName) => {
        if (views[modalName]) views[modalName].classList.add('hidden');
    };

    // --- RENDER FUNCTIONS (UI Updates) ---
    const renderGameRoom = () => {
        if (appState.view !== 'gameRoom') return;
        const { game, myId, isHost } = appState;

        document.getElementById('room-code-display').textContent = appState.roomCode;
        document.getElementById('player-role').textContent = isHost ? 'You are the Host' : 'You are the Guest';
        
        const menuDropdown = document.getElementById('game-menu-dropdown');
        menuDropdown.innerHTML = ''; // Clear old items
        if (isHost) {
            menuDropdown.innerHTML = `
                <a href="#" id="start-game-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-blue-500 hover:text-white">Start Game</a>
                <a href="#" id="restart-round-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-yellow-500 hover:text-white">Restart Round</a>
                <a href="#" id="issue-win-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-indigo-500 hover:text-white">Issue Win</a>
                <a href="#" id="kick-guest-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-orange-500 hover:text-white">Kick Guest</a>
                <a href="#" id="end-session-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-red-500 hover:text-white">End Session</a>
                <button id="open-presenter-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-purple-500 hover:text-white">Open Presenter</button>
            `;
        } else {
             menuDropdown.innerHTML = `<a href="#" id="leave-battle-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-red-500 hover:text-white">Leave Battle</a>`;
        }


        const me = game.players[myId];
        if (!me) {
            document.getElementById('waiting-for-opponent').style.display = 'block';
            document.getElementById('game-controls').style.display = 'none';
            return;
        }

        const connectedPlayerCount = Object.values(game.players).filter(p => p.connected).length;
        
        if (game.status === 'paused') {
             document.getElementById('waiting-for-opponent').style.display = 'none';
             document.getElementById('game-controls').style.display = 'block';
        } else {
            document.getElementById('waiting-for-opponent').style.display = connectedPlayerCount < 2 ? 'block' : 'none';
            document.getElementById('game-controls').style.display = connectedPlayerCount >= 2 ? 'block' : 'none';
        }

        const p1Id = Object.keys(game.players).find(id => game.players[id].isHost);
        const p2Id = Object.keys(game.players).find(id => !game.players[id].isHost);
        const p1Indicator = document.getElementById('player1-turn-indicator');
        const p2Indicator = document.getElementById('player2-turn-indicator');
        
        document.getElementById('pokemon-controls').classList.add('hidden');
        document.getElementById('lorcana-controls').classList.add('hidden');
        document.getElementById('mtg-controls').classList.add('hidden');
        document.getElementById('yugioh-controls').classList.add('hidden');
        document.getElementById('onepiece-controls').classList.add('hidden');

        if (game.tcg === 'pokemon') {
            document.getElementById('pokemon-controls').classList.remove('hidden');
            renderPrizeCards(me);
            renderAdditionalTracking(me);
            if (p1Id && game.players[p1Id]) {
                const p1 = game.players[p1Id];
                const p1PrizesLeft = game.prizeCount - p1.prizesTaken.length;
                document.getElementById('player1-name-turn').textContent = `${p1.name} (${p1PrizesLeft} Prizes)`;
            }
            if (p2Id && game.players[p2Id]) {
                const p2 = game.players[p2Id];
                const p2PrizesLeft = game.prizeCount - p2.prizesTaken.length;
                document.getElementById('player2-name-turn').textContent = `${p2.name} (${p2PrizesLeft} Prizes)`;
            }
        } else if (game.tcg === 'lorcana') {
            document.getElementById('lorcana-controls').classList.remove('hidden');
            renderLorcanaControls(me);
            if (p1Id && game.players[p1Id]) {
                document.getElementById('player1-name-turn').textContent = `${game.players[p1Id].name} (${game.players[p1Id].loreCount} Lore)`;
            }
            if (p2Id && game.players[p2Id]) {
                document.getElementById('player2-name-turn').textContent = `${game.players[p2Id].name} (${game.players[p2Id].loreCount} Lore)`;
            }
        } else if (game.tcg === 'mtg') {
            document.getElementById('mtg-controls').classList.remove('hidden');
            renderMtgControls(me);
            if (p1Id && game.players[p1Id]) {
                document.getElementById('player1-name-turn').textContent = `${game.players[p1Id].name} (${game.players[p1Id].life} Life)`;
            }
            if (p2Id && game.players[p2Id]) {
                document.getElementById('player2-name-turn').textContent = `${game.players[p2Id].name} (${game.players[p2Id].life} Life)`;
            }
        } else if (game.tcg === 'yugioh') {
            document.getElementById('yugioh-controls').classList.remove('hidden');
            renderYugiohControls(me);
            if (p1Id && game.players[p1Id]) {
                document.getElementById('player1-name-turn').textContent = `${game.players[p1Id].name} (${game.players[p1Id].lp})`;
            }
            if (p2Id && game.players[p2Id]) {
                document.getElementById('player2-name-turn').textContent = `${game.players[p2Id].name} (${game.players[p2Id].lp})`;
            }
        } else if (game.tcg === 'onepiece') {
            document.getElementById('onepiece-controls').classList.remove('hidden');
            renderOnePieceControls(me);
            if (p1Id && game.players[p1Id]) {
                document.getElementById('player1-name-turn').textContent = `${game.players[p1Id].name} (${game.players[p1Id].life} Life)`;
            }
            if (p2Id && game.players[p2Id]) {
                document.getElementById('player2-name-turn').textContent = `${game.players[p2Id].name} (${game.players[p2Id].life} Life)`;
            }
        }

        p1Indicator.classList.remove('turn-indicator-glow');
        p2Indicator.classList.remove('turn-indicator-glow');
        if (game.turn === p1Id) p1Indicator.classList.add('turn-indicator-glow');
        if (game.turn === p2Id) p2Indicator.classList.add('turn-indicator-glow');

        let statusText = "Waiting to start...";
        if (game.status === 'setting_life') {
            statusText = "Setting starting life...";
        } else if (game.status === 'active') {
            statusText = "Game in progress!";
            if (game.gameMode === 'bestOfThree') {
                statusText = `Game ${game.currentGame} of 3`;
            }
        }
        if (game.status === 'overtime') {
            statusText = "Time expired! Turns start now!";
        }
        if (game.status === 'paused') statusText = "Game Paused - Opponent Disconnected";
        if (game.status === 'finished') {
            const winner = game.players[game.winnerId];
            if (game.isTie) {
                statusText = "Match Tied!";
            } else if (winner) {
                statusText = `Match Over! ${winner.name} is the winner!`;
            } else {
                statusText = "Match Over!";
            }
        } else if (game.status === 'game-over') {
            const roundWinner = game.players[game.roundWinnerId];
            if(roundWinner) statusText = `${roundWinner.name} wins Game ${game.currentGame}!`;
        }
        document.getElementById('game-status-text').textContent = statusText;

        renderTimerDisplay();
        renderActionButtons();
    };

    const renderPrizeCards = (me) => {
        const prizeGrid = document.getElementById('prize-card-grid');
        prizeGrid.innerHTML = '';
        for (let i = 1; i <= appState.game.prizeCount; i++) {
            const card = document.createElement('button');
            card.dataset.prizeId = i;
            card.className = 'prize-card p-4 sm:p-6 rounded-lg font-bold text-2xl bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed';
            card.textContent = i;
            if (me.prizesTaken.includes(i)) card.classList.add('taken');
            card.disabled = appState.game.status !== 'active';
            prizeGrid.appendChild(card);
        }
    };

    const renderAdditionalTracking = (me) => {
        const container = document.getElementById('additional-tracking-buttons');
        if (!appState.game.additionalTrackingEnabled) {
            container.classList.add('hidden');
            return;
        }
        container.classList.remove('hidden');

        const isMyTurn = appState.myId === appState.game.turn;
        
        container.querySelectorAll('.action-btn').forEach(btn => {
            const action = btn.dataset.action;
            btn.classList.toggle('used', me.actionsUsed[action]);
            btn.disabled = !isMyTurn || appState.game.status !== 'active';
        });
    };

    const renderLorcanaControls = (me) => {
        const loreTracker = document.getElementById('lore-tracker');
        loreTracker.innerHTML = `
            <button id="lore-up-btn" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-up fa-3x"></i></button>
            <div class="my-2 flex items-center">
                ${loreIconSVG}
                <span id="lore-count" class="text-6xl font-bold ml-4">${me.loreCount}</span>
            </div>
            <button id="lore-down-btn" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-down fa-3x"></i></button>
        `;
    };

    const renderMtgControls = (me) => {
        const lifeTracker = document.getElementById('life-tracker');
        lifeTracker.innerHTML = `
            <button id="life-up-btn" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-up fa-3x"></i></button>
            <div class="d20-life-container my-2">
                <img src="https://tcgbattle.netlify.app/images/d20.png" alt="D20 Life Counter" class="d20-life-bg">
                <span class="d20-life-text">${me.life}</span>
            </div>
            <button id="life-down-btn" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-down fa-3x"></i></button>
        `;
    };

    const renderYugiohControls = (me) => {
        const lpTracker = document.getElementById('lp-tracker');
        lpTracker.innerHTML = `
            <div class="text-6xl font-bold mb-4">${me.lp}</div>
            <div class="grid grid-cols-4 gap-2 w-full max-w-sm">
                <button data-lp="-1000" class="lp-btn bg-red-600 hover:bg-red-700 p-2 rounded">-1000</button>
                <button data-lp="-100" class="lp-btn bg-red-600 hover:bg-red-700 p-2 rounded">-100</button>
                <button data-lp="-10" class="lp-btn bg-red-600 hover:bg-red-700 p-2 rounded">-10</button>
                <button data-lp="-1" class="lp-btn bg-red-600 hover:bg-red-700 p-2 rounded">-1</button>
                <button data-lp="1000" class="lp-btn bg-green-600 hover:bg-green-700 p-2 rounded">+1000</button>
                <button data-lp="100" class="lp-btn bg-green-600 hover:bg-green-700 p-2 rounded">+100</button>
                <button data-lp="10" class="lp-btn bg-green-600 hover:bg-green-700 p-2 rounded">+10</button>
                <button data-lp="1" class="lp-btn bg-green-600 hover:bg-green-700 p-2 rounded">+1</button>
            </div>
            <button id="calculator-open-btn" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-calculator mr-2"></i>Calculator</button>
        `;
    };

    const renderOnePieceControls = (me) => {
        const lifeContainer = document.getElementById('onepiece-life-tracker');
        const donContainer = document.getElementById('don-tracker');
        const finalAttackBtn = document.getElementById('final-attack-btn');
        const opponent = Object.values(appState.game.players).find(p => p.name !== me.name);

        lifeContainer.innerHTML = `
            <h3 class="font-bold text-xl mb-2">Your Life</h3>
            <div class="flex items-center justify-center space-x-4">
                <button id="op-life-down-btn" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-down fa-2x"></i></button>
                <span class="text-5xl font-bold">${me.life}</span>
                <button id="op-life-up-btn" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-arrow-up fa-2x"></i></button>
            </div>
        `;

        if (appState.game.donTrackerEnabled) {
            donContainer.classList.remove('hidden');
            donContainer.innerHTML = `
                <h3 class="font-bold text-xl mb-2">DON!!</h3>
                <div class="flex items-center justify-center space-x-6">
                    <div>
                        <p class="font-bold">Active: ${me.don.active}</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <button data-don-type="active" data-don-change="-1" class="don-btn bg-red-600 w-8 h-8 rounded">-</button>
                            <button data-don-type="active" data-don-change="1" class="don-btn bg-green-600 w-8 h-8 rounded">+</button>
                        </div>
                    </div>
                    <button id="rest-don-btn" class="bg-yellow-500 hover:bg-yellow-600 p-2 rounded">Rest 1 DON!!</button>
                    <div>
                        <p class="font-bold">Rested: ${me.don.rested}</p>
                    </div>
                </div>
            `;
        } else {
            donContainer.classList.add('hidden');
        }

        if (opponent && opponent.life <= 0) {
            finalAttackBtn.classList.remove('hidden');
        } else {
            finalAttackBtn.classList.add('hidden');
        }
    };

    const renderTimerDisplay = () => {
        const timerDisplay = document.getElementById('timer-display-controls');
        if (!timerDisplay) return;

        const { timerType, timerState } = appState.game;
        let html = '';

        if (timerType === 'countdown') {
            const timeRemaining = (appState.game.countdownMinutes * 60 * 1000) - timerState.elapsed;
            html = `<p class="text-4xl font-bold tabular-nums">${formatTime(timeRemaining)}</p>`;
        } else {
            const p1Id = Object.keys(appState.game.players).find(id => appState.game.players[id].isHost);
            const p2Id = Object.keys(appState.game.players).find(id => !appState.game.players[id].isHost);
            const p1Time = timerState.playerTimes[p1Id] ?? (appState.game.chessMinutes * 60000);
            const p2Time = timerState.playerTimes[p2Id] ?? (appState.game.chessMinutes * 60000);
            html = `
                <div class="flex justify-around items-center text-3xl font-bold tabular-nums">
                    <div>
                        <p class="text-sm">${p1Id ? appState.game.players[p1Id].name : 'Host'}</p>
                        <p>${formatTime(p1Time)}</p>
                    </div>
                    <div>
                        <p class="text-sm">${p2Id ? appState.game.players[p2Id].name : 'Guest'}</p>
                        <p>${formatTime(p2Time)}</p>
                    </div>
                </div>`;
        }
        timerDisplay.innerHTML = html;
    };
    
    const renderActionButtons = () => {
        const controlsContainer = document.getElementById('turn-controls');
        controlsContainer.innerHTML = '';
        if (appState.game.status !== 'active' && appState.game.status !== 'overtime') return;

        const isMyTurn = appState.myId === appState.game.turn;

        const buttonWrapper = document.createElement('div');
        buttonWrapper.className = 'flex items-center justify-center space-x-4';

        const endTurnBtn = document.createElement('button');
        endTurnBtn.id = 'end-turn-btn';
        endTurnBtn.className = 'flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed';
        endTurnBtn.textContent = 'End Turn';
        endTurnBtn.disabled = !isMyTurn;

        const scoopBtn = document.createElement('button');
        scoopBtn.id = 'scoop-btn';
        scoopBtn.className = 'flex-shrink-0 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed';
        scoopBtn.textContent = 'SCOOP!';
        scoopBtn.disabled = appState.game.status !== 'active' && appState.game.status !== 'overtime';

        buttonWrapper.appendChild(endTurnBtn);
        buttonWrapper.appendChild(scoopBtn);
        controlsContainer.appendChild(buttonWrapper);
    };

    const renderPresenter = () => {
        if (appState.view !== 'presenter') return;
        const { game } = appState;

        const p1Id = Object.keys(game.players).find(id => game.players[id].isHost);
        const p2Id = Object.keys(game.players).find(id => !game.players[id].isHost);
        
        const p1 = p1Id ? game.players[p1Id] : { name: 'Host', prizesTaken: [], loreCount: 0, life: 20, lp: 8000, color: '#cccccc', actionsUsed: {} };
        const p2 = p2Id ? game.players[p2Id] : { name: 'Guest', prizesTaken: [], loreCount: 0, life: 20, lp: 8000, color: '#cccccc', actionsUsed: {} };

        document.getElementById('presenter-p1-name').textContent = p1.name;
        document.getElementById('presenter-p2-name').textContent = p2.name;
        document.getElementById('presenter-room-code').textContent = appState.roomCode;
        
        const p1Avatar = document.getElementById('presenter-p1-avatar');
        p1Avatar.innerHTML = trainerSilhouetteSVG;
        p1Avatar.style.color = p1.color;
        p1Avatar.classList.toggle('turn-indicator-glow', game.turn === p1Id);

        const p2Avatar = document.getElementById('presenter-p2-avatar');
        p2Avatar.innerHTML = trainerSilhouetteSVG;
        p2Avatar.style.color = p2.color;
        p2Avatar.classList.toggle('turn-indicator-glow', game.turn === p2Id);

        if (game.gameMode === 'bestOfThree') {
            document.getElementById('presenter-game-number').textContent = `Game ${game.currentGame}`;
            document.getElementById('presenter-p1-wins').textContent = `${game.wins[p1Id] || 0} Wins`;
            document.getElementById('presenter-p2-wins').textContent = `${game.wins[p2Id] || 0} Wins`;
        } else {
            document.getElementById('presenter-game-number').textContent = '';
            document.getElementById('presenter-p1-wins').textContent = '';
            document.getElementById('presenter-p2-wins').textContent = '';
        }

        const p1Lore = document.getElementById('presenter-p1-lore');
        const p2Lore = document.getElementById('presenter-p2-lore');
        const p1Life = document.getElementById('presenter-p1-life');
        const p2Life = document.getElementById('presenter-p2-life');
        const p1Lp = document.getElementById('presenter-p1-lp');
        const p2Lp = document.getElementById('presenter-p2-lp');
        
        // Hide all game-specific displays initially
        document.getElementById('presenter-p1-prizes').classList.add('hidden');
        document.getElementById('presenter-p2-prizes').classList.add('hidden');
        document.getElementById('presenter-p1-actions').classList.add('hidden');
        document.getElementById('presenter-p2-actions').classList.add('hidden');
        p1Lore.classList.add('hidden');
        p2Lore.classList.add('hidden');
        p1Life.classList.add('hidden');
        p2Life.classList.add('hidden');
        p1Lp.classList.add('hidden');
        p2Lp.classList.add('hidden');

        if (game.tcg === 'pokemon') {
            document.getElementById('presenter-p1-prizes').classList.remove('hidden');
            document.getElementById('presenter-p2-prizes').classList.remove('hidden');
            renderPrizesInArc(p1, 'presenter-p1-prizes', true);
            renderPrizesInArc(p2, 'presenter-p2-prizes', false);
            renderPresenterActions(p1, 'presenter-p1-actions');
            renderPresenterActions(p2, 'presenter-p2-actions');
        } else if (game.tcg === 'lorcana') {
            p1Lore.classList.remove('hidden');
            p2Lore.classList.remove('hidden');
            p1Lore.innerHTML = `${loreIconSVG} <span class="ml-2">${p1.loreCount} Lore</span>`;
            p2Lore.innerHTML = `${loreIconSVG} <span class="ml-2">${p2.loreCount} Lore</span>`;
        } else if (game.tcg === 'mtg') {
            p1Life.classList.remove('hidden');
            p2Life.classList.remove('hidden');
            p1Life.textContent = `${p1.life} Life Remaining`;
            p2Life.textContent = `${p2.life} Life Remaining`;
        } else if (game.tcg === 'yugioh') {
            p1Lp.classList.remove('hidden');
            p2Lp.classList.remove('hidden');
            p1Lp.textContent = `${p1.lp} Life Points`;
            p2Lp.textContent = `${p2.lp} Life Points`;
        }

        const countdownTimerEl = document.getElementById('presenter-timer');
        const chessTimersEl = document.getElementById('presenter-chess-timers');
        const p1ChessEl = document.getElementById('presenter-chess-p1');
        const p2ChessEl = document.getElementById('presenter-chess-p2');

        if (game.timerType === 'countdown') {
            countdownTimerEl.classList.remove('hidden');
            chessTimersEl.classList.add('hidden');
            const timeRemaining = (appState.game.countdownMinutes * 60 * 1000) - game.timerState.elapsed;
            countdownTimerEl.textContent = formatTime(timeRemaining);
        } else {
            countdownTimerEl.classList.add('hidden');
            chessTimersEl.classList.remove('hidden');
            const p1Time = game.timerState.playerTimes[p1Id] ?? (appState.game.chessMinutes * 60000);
            const p2Time = game.timerState.playerTimes[p2Id] ?? (appState.game.chessMinutes * 60000);
            p1ChessEl.textContent = formatTime(p1Time);
            p2ChessEl.textContent = formatTime(p2Time);
            p1ChessEl.style.color = p1.color;
            p2ChessEl.style.color = p2.color;
        }
    };

    const renderPrizesInArc = (player, containerId, isReversed) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const numPrizes = appState.game.prizeCount;
        const radius = 220;
        const totalAngle = 150; 
        const angleStep = numPrizes > 1 ? totalAngle / (numPrizes - 1) : 0;
        const startAngle = -75; 

        for (let i = 1; i <= numPrizes; i++) {
            const angle = startAngle + (angleStep * (i - 1));
            const radians = angle * (Math.PI / 180);

            const x = radius * Math.cos(radians);
            const y = radius * Math.sin(radians);

            const prizeEl = document.createElement('div');
            prizeEl.className = 'presenter-prize-pokeball';
            prizeEl.style.transform = `translate(${isReversed ? -x : x}px, ${y}px)`;
            
            const taken = player.prizesTaken.includes(i);
            if(taken) prizeEl.classList.add('taken');
            container.appendChild(prizeEl);
        }
    };

    const renderPresenterActions = (player, containerId) => {
        const container = document.getElementById(containerId);
        if (!appState.game.additionalTrackingEnabled) {
            container.classList.add('hidden');
            return;
        }
        container.classList.remove('hidden');
        container.innerHTML = `
            <div class="presenter-action-emblem ${player.actionsUsed.supporter ? 'used' : ''}" style="background-color: #3b82f6;">Su</div>
            <div class="presenter-action-emblem ${player.actionsUsed.energy ? 'used' : ''}" style="background-color: #eab308;">En</div>
            <div class="presenter-action-emblem ${player.actionsUsed.retreat ? 'used' : ''}" style="background-color: #22c55e;">Re</div>
            <div class="presenter-action-emblem ${player.actionsUsed.stadium ? 'used' : ''}" style="background-color: #8b5cf6;">St</div>
        `;
    };

    const renderChooseFirstPlayerModal = () => {
        const optionsDiv = document.getElementById('first-player-options');
        optionsDiv.innerHTML = ''; // Clear previous options

        Object.keys(appState.game.players).forEach(playerId => {
            const player = appState.game.players[playerId];
            const btn = document.createElement('button');
            btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl';
            btn.textContent = player.name;
            btn.dataset.playerId = playerId;
            optionsDiv.appendChild(btn);
        });

        showModal('chooseFirstPlayerModal');
    };

    const renderIssueWinModal = () => {
        const optionsDiv = document.getElementById('issue-win-options');
        optionsDiv.innerHTML = ''; // Clear previous options

        Object.keys(appState.game.players).forEach(playerId => {
            const player = appState.game.players[playerId];
            const btn = document.createElement('button');
            btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl';
            btn.textContent = `Award Win to ${player.name}`;
            btn.dataset.playerId = playerId;
            optionsDiv.appendChild(btn);
        });

        if (appState.game.timerType === 'countdown') {
            const tieBtn = document.createElement('button');
            tieBtn.className = 'w-full bg-gray-500 hover:bg-gray-400 text-white font-bold py-3 px-4 rounded-lg text-xl mt-2';
            tieBtn.textContent = 'Declare a Tie';
            tieBtn.dataset.playerId = 'tie';
            optionsDiv.appendChild(tieBtn);
        }

        showModal('issueWinModal');
    };

    const showWinnerAnimation = (winner, isRoundWin = false, isTie = false) => {
        const winnerTitle = document.getElementById('winner-title');
        const winnerName = document.getElementById('winner-name');
        const buttonContainer = document.getElementById('winner-modal-buttons');
        buttonContainer.innerHTML = ''; // Clear previous buttons

        if (isTie) {
            winnerTitle.textContent = "TIE!";
            winnerName.textContent = "The round results in a tie!";
        } else if (winner) {
            winnerTitle.textContent = isRoundWin ? "ROUND WINNER!" : "WINNER!";
            winnerName.textContent = isRoundWin ? `${winner.name} wins the round!` : winner.name;
        } else {
            return; // No winner to show
        }
        
        const wasHostWhenModalOpened = appState.isHost;

        if (wasHostWhenModalOpened) {
            const btn = document.createElement('button');
            if (appState.game.status === 'game-over') {
                btn.id = 'next-game-btn';
                btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded';
                btn.textContent = 'Next Game';
            } else {
                btn.id = 'play-again-btn';
                btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded';
                btn.textContent = 'Play Again';
            }
            buttonContainer.appendChild(btn);
        } else {
            const closeBtn = document.createElement('button');
            closeBtn.id = 'close-winner-btn';
            closeBtn.className = 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded';
            closeBtn.textContent = 'Close';
            buttonContainer.appendChild(closeBtn);
        }

        showModal('winnerModal');
        appState.winnerAnnounced = true;
    };

    const fullRender = () => {
        if (appState.game.status === 'setting_life' && !views.setStartingLifeModal.classList.contains('hidden')) {
            showModal('setStartingLifeModal');
        }

        renderGameRoom();
        renderPresenter();

        if (appState.game.status === 'finished' && !appState.winnerAnnounced) {
            // Final match winner
            const winner = appState.game.players[appState.game.winnerId];
            showWinnerAnimation(winner, false, appState.game.isTie); // isRoundWin is false
        } else if (appState.game.status === 'game-over' && !appState.winnerAnnounced) {
            // Intermediate game winner in Best-of-Three
            const winner = appState.game.players[appState.game.roundWinnerId];
            showWinnerAnimation(winner, true, false); // isRoundWin is true
        }
    };

    // --- PUSHER LOGIC ---
    const initPusher = () => {
        appState.pusher = new Pusher(PUSHER_APP_KEY, {
            cluster: PUSHER_CLUSTER,
            authEndpoint: '/.netlify/functions/pusher-auth',
            auth: {
                params: {
                    playerName: appState.playerName,
                    isHost: appState.isHost
                }
            }
        });
    };

    const subscribeToChannel = (roomCode) => {
        appState.roomCode = roomCode;
        appState.channel = appState.pusher.subscribe(`presence-tcg-battle-${roomCode}`);

        appState.channel.bind('pusher:subscription_succeeded', (members) => {
            console.log('Subscribed to channel:', roomCode);
            appState.myId = appState.channel.members.me.id;
            
            let wasDemoted = false;
            if (appState.isHost) {
                let anotherHostExists = false;
                members.each(member => {
                    if (member.id !== appState.myId && member.info.isHost) {
                        anotherHostExists = true;
                    }
                });

                if (anotherHostExists) {
                    console.warn("Another host found. Demoting self to guest.");
                    appState.isHost = false;
                    wasDemoted = true;
                    const sessionData = JSON.parse(sessionStorage.getItem('tcgBattleSession'));
                    if (sessionData) {
                        sessionData.isHost = false;
                        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
                    }
                    fullRender();
                }
            }

            if (appState.isHost) {
                console.log("I am the host.");
                if (Object.keys(appState.game.players).length === 0) {
                    appState.game.players[appState.myId] = createPlayerObject(appState.playerName, true, avatarColors[0]);
                }
                
                if(appState.game.players[appState.myId]) {
                    appState.game.players[appState.myId].connected = true;
                }

                broadcastGameState();
                fullRender();
            } else {
                console.log("I am a guest, waiting for host state...");
                if (!wasDemoted) {
                    const roomCheckTimeout = setTimeout(() => {
                        let hostExists = false;
                        appState.channel.members.each(member => {
                            if (member.info.isHost) {
                                hostExists = true;
                            }
                        });

                        if (!hostExists) {
                            alert("Room not found or host has left. Returning to home.");
                            sessionStorage.removeItem('tcgBattleSession');
                            window.location.href = window.location.pathname;
                        }
                    }, 3000);

                    appState.roomCheckTimeout = roomCheckTimeout;
                }
            }
            
            if (appState.isHost) {
                bindHostEvents();
            }
        });

        appState.channel.bind('pusher:member_added', (member) => {
            if (appState.isHost && member.id !== appState.myId) {
                console.log('Member added:', member.id);

                const returningPlayerEntry = Object.entries(appState.game.players).find(([id, player]) => player.name === member.info.playerName && !player.connected);

                if (returningPlayerEntry) {
                    console.log('Player is reconnecting...');
                    const [oldId, playerData] = returningPlayerEntry;

                    delete appState.game.players[oldId];

                    appState.game.players[member.id] = {
                        ...playerData, // Copy all existing data
                        isHost: false, // Force guest status on reconnect
                        connected: true
                    };
                    
                    // FIX: Transfer win count to the new player ID
                    if (appState.game.wins[oldId] !== undefined) {
                        appState.game.wins[member.id] = appState.game.wins[oldId];
                        delete appState.game.wins[oldId];
                    }

                    if (appState.game.timerType === 'chess') {
                        const oldTime = appState.game.timerState.playerTimes[oldId];
                        if (oldTime !== undefined) {
                            appState.game.timerState.playerTimes[member.id] = oldTime;
                            delete appState.game.timerState.playerTimes[oldId];
                        }
                    }

                    if (appState.game.turn === oldId) {
                        appState.game.turn = member.id;
                    }
                    
                    const allPlayersConnected = Object.values(appState.game.players).every(p => p.connected);
                    if (allPlayersConnected && Object.keys(appState.game.players).length === 2) {
                        appState.game.status = 'active';
                        appState.game.timerState.running = true;
                        startTimer();
                    }
                } else if (Object.keys(appState.game.players).length < 2) {
                    console.log('New player is joining...');
                    appState.game.players[member.id] = createPlayerObject(member.info.playerName, false, avatarColors[1]);
                } else {
                    console.log("Spectator/Presenter joined. Not adding to game.");
                }

                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('pusher:member_removed', (member) => {
             if (appState.isHost) {
                 console.log('Host saw member removed:', member.id);
                 const player = appState.game.players[member.id];
                 if (player) {
                     player.connected = false;
                     appState.game.status = 'paused';
                     appState.game.timerState.running = false;
                     broadcastGameState();
                     fullRender();
                 }
             } else {
                 const removedPlayer = appState.game.players[member.id];
                 if (removedPlayer && removedPlayer.isHost) {
                     console.log("Host disconnected. Guest is becoming the new host.");
                     appState.isHost = true;
                     
                     const sessionData = JSON.parse(sessionStorage.getItem('tcgBattleSession'));
                     if (sessionData) {
                         sessionData.isHost = true;
                         sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
                     }
                     
                     const myPlayerData = appState.game.players[appState.myId];
                     myPlayerData.isHost = true;
                     myPlayerData.connected = true;

                     removedPlayer.connected = false; 

                     appState.game.status = 'paused';
                     appState.game.timerState.running = false;
                     
                     broadcastGameState();
                     fullRender();
                     bindHostEvents();
                 }
             }
        });
        
        appState.channel.bind('client-state-update', (data) => {
            if (!appState.isHost) {
                if (appState.roomCheckTimeout) {
                    console.log("Received host state, cancelling room check timeout.");
                    clearTimeout(appState.roomCheckTimeout);
                    appState.roomCheckTimeout = null;
                }

                console.log('Guest/Presenter received state update:', data);
                // When a new game state arrives, if the status is different, reset the announcement flag
                if (appState.game.status !== data.status) {
                    appState.winnerAnnounced = false;
                }
                appState.game = data;
                
                if (!appState.game.timerState.running && timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                fullRender();
            }
        });
        
        appState.channel.bind('client-session-ended', () => {
            sessionStorage.removeItem('tcgBattleSession');
            localStorage.removeItem(`tcgBattleState-${appState.roomCode}`);
            alert('The host has ended the session.');
            window.location.href = window.location.pathname;
        });
    };

    const broadcastGameState = () => {
        if (!appState.channel || !appState.isHost) return;
        try {
            localStorage.setItem(`tcgBattleState-${appState.roomCode}`, JSON.stringify(appState.game));
            appState.channel.trigger('client-state-update', appState.game);
        } catch (error) {
            console.error("Pusher trigger failed:", error);
        }
    };

    const handleGameWin = (winnerId) => {
        if (!appState.isHost) return;

        // winnerId is the winner of the current game.
        appState.game.roundWinnerId = winnerId;
        appState.game.timerState.running = false; // Stop timer for this game.

        if (appState.game.gameMode === 'bestOfThree') {
            appState.game.wins[winnerId] = (appState.game.wins[winnerId] || 0) + 1;

            if (appState.game.wins[winnerId] >= 2) {
                // Match is over
                appState.game.winnerId = winnerId;
                appState.game.status = 'finished';
            } else {
                // Game is over, but match continues
                appState.game.status = 'game-over';
            }
        } else {
            // Basic mode, game and match are over
            appState.game.winnerId = winnerId;
            appState.game.status = 'finished';
        }

        playBuzzer();
        broadcastGameState();
        fullRender();
    };

    const handleScoop = (loserId) => {
        const winnerId = Object.keys(appState.game.players).find(id => id !== loserId);
        if (!winnerId) return;
        handleGameWin(winnerId);
    };

    const handleIssueWin = (winnerId) => {
        if (!appState.isHost) return;
        handleGameWin(winnerId);
    };

    const handleTie = () => {
        if (!appState.isHost) return;

        const pIds = Object.keys(appState.game.players);
        const p1Id = pIds[0];
        const p2Id = pIds[1];
        const p1Wins = appState.game.wins[p1Id] || 0;
        const p2Wins = appState.game.wins[p2Id] || 0;

        if (p1Wins > p2Wins) {
            appState.game.roundWinnerId = p1Id;
        } else if (p2Wins > p1Wins) {
            appState.game.roundWinnerId = p2Id;
        } else {
            appState.game.isTie = true;
        }

        appState.game.status = 'finished';
        appState.game.timerState.running = false;
        playBuzzer();
        broadcastGameState();
        fullRender();
    };

    const bindHostEvents = () => {
        if (!appState.channel) return;

        appState.channel.unbind('client-update-prizes');
        appState.channel.unbind('client-end-turn');
        appState.channel.unbind('client-scoop-game');
        appState.channel.unbind('client-update-lore');
        appState.channel.unbind('client-update-action');
        appState.channel.unbind('client-update-life');
        appState.channel.unbind('client-update-lp');
        appState.channel.bind('client-submit-life', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].life = data.life;
                appState.game.players[playerId].lifeSubmitted = true;
                
                const allSubmitted = Object.values(appState.game.players).every(p => p.lifeSubmitted);
                if (allSubmitted) {
                    hideModal('setStartingLifeModal');
                    renderChooseFirstPlayerModal();
                }
                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('client-update-prizes', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].prizesTaken = data.prizes;
                
                if (data.prizes.length >= appState.game.prizeCount) {
                    handleGameWin(playerId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            }
        });

        appState.channel.bind('client-update-lore', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].loreCount = data.loreCount;
                if (data.loreCount >= appState.game.loreToWin) {
                    handleGameWin(playerId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            }
        });

        appState.channel.bind('client-update-life', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].life = data.life;
                if (data.life <= 0) {
                    const player = appState.game.players[playerId];
                    document.getElementById('zero-life-prompt').textContent = `${player.name} is at 0 life. Did they lose the game?`;
                    showModal('zeroLifeModal');
                }
                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('client-update-lp', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].lp = data.lp;
                if (data.lp <= 0) {
                    const opponentId = Object.keys(appState.game.players).find(id => id !== playerId);
                    handleGameWin(opponentId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            }
        });

        appState.channel.bind('client-update-action', (data, metadata) => {
            const playerId = metadata.user_id;
            if (appState.game.players[playerId]) {
                appState.game.players[playerId].actionsUsed[data.action] = data.used;
                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('client-end-turn', (data, metadata) => {
            const previousPlayerId = metadata.user_id;
            if (appState.game.turn === previousPlayerId) {
                if (appState.game.players[previousPlayerId]) {
                    appState.game.players[previousPlayerId].actionsUsed = { supporter: false, energy: false, retreat: false, stadium: false };
                }
                appState.game.turn = data.turn;
                broadcastGameState();
                fullRender();
            }
        });

        appState.channel.bind('client-scoop-game', (data, metadata) => {
            handleScoop(metadata.user_id);
        });

        console.log("Host events have been successfully bound.");
    };
    
    let timerInterval;
    const startTimer = () => {
        if (timerInterval) clearInterval(timerInterval);
        if (!appState.game.timerState.running || !appState.isHost) return;

        let lastTick = Date.now();
        timerInterval = setInterval(() => {
            if (!appState.game.timerState.running) {
                clearInterval(timerInterval);
                timerInterval = null;
                return;
            }
            const delta = Date.now() - lastTick;
            lastTick = Date.now();
            
            const { timerType } = appState.game;
            let timeIsUp = false;

            if (timerType === 'countdown') {
                appState.game.timerState.elapsed += delta;
                if ((appState.game.countdownMinutes * 60 * 1000) - appState.game.timerState.elapsed < 1) {
                    timeIsUp = true;
                    appState.game.timerState.elapsed = appState.game.countdownMinutes * 60 * 1000;
                }
            } else { // chess
                const { turn } = appState.game;
                if (turn && appState.game.timerState.playerTimes[turn]) {
                    appState.game.timerState.playerTimes[turn] -= delta;
                    if (appState.game.timerState.playerTimes[turn] <= 0) {
                        appState.game.timerState.playerTimes[turn] = 0;
                        timeIsUp = true;
                    }
                }
            }
            
            if (timeIsUp) {
                clearInterval(timerInterval);
                timerInterval = null;
                appState.game.timerState.running = false;
                playBuzzer();

                if (timerType === 'countdown') {
                    appState.game.status = 'overtime';
                } else { // Chess clock timeout
                    const loserId = appState.game.turn;
                    handleGameWin(Object.keys(appState.game.players).find(id => id !== loserId));
                }
                
                broadcastGameState();
                fullRender();
            } else {
                broadcastGameState();
                fullRender();
            }
        }, 1000);
    };

    const startGameWithFirstPlayer = (firstPlayerId, isFirstGame = true) => {
        if (!appState.isHost) return;

        // Reset state for the new game/round
        appState.game.status = 'active';
        appState.game.turn = firstPlayerId;
        appState.winnerAnnounced = false;
        appState.game.roundWinnerId = null;
        appState.game.isTie = false;

        Object.values(appState.game.players).forEach(p => {
            p.prizesTaken = [];
            p.loreCount = 0;
            if (appState.game.tcg !== 'onepiece') { // Keep submitted life for One Piece
                p.life = appState.game.startingLife;
            }
            p.lp = appState.game.startingLP;
            p.actionsUsed = { supporter: false, energy: false, retreat: false, stadium: false };
        });

        if (isFirstGame) {
            // Reset state for the entire match
            appState.game.timerState.startTime = Date.now();
            appState.game.timerState.elapsed = 0;
            appState.game.currentGame = 1;
            appState.game.wins = {};
            appState.game.winnerId = null; // Reset overall match winner only on the very first game
            Object.keys(appState.game.players).forEach(id => {
                appState.game.wins[id] = 0;
            });
            if (appState.game.timerType === 'chess') {
                Object.keys(appState.game.players).forEach(id => {
                    appState.game.timerState.playerTimes[id] = appState.game.chessMinutes * 60 * 1000;
                });
            }
        } else {
            // Just advance to the next game in the match
            appState.game.currentGame++;
        }

        // Always start/resume the timer for the new game
        appState.game.timerState.running = true;
        startTimer();

        broadcastGameState();
        fullRender();
    };

    const playBuzzer = () => {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
            gainNode.gain.setValueAtTime(1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 1);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        } catch (e) { console.error("Could not play buzzer sound:", e); }
    };

    // --- CALCULATOR LOGIC ---
    const initCalculator = () => {
        const display = document.getElementById('calculator-display');
        const buttonsContainer = document.getElementById('calculator-buttons');
        let currentInput = '0';
        let previousInput = '';
        let operator = null;

        const updateDisplay = () => {
            display.textContent = currentInput;
        };

        const handleNumber = (value) => {
            if (currentInput === '0') {
                currentInput = value;
            } else {
                currentInput += value;
            }
        };

        const handleOperator = (value) => {
            if (operator !== null) {
                handleEquals();
            }
            previousInput = currentInput;
            currentInput = '0';
            operator = value;
        };

        const handleEquals = () => {
            if (operator === null || previousInput === '') return;
            const prev = parseFloat(previousInput);
            const curr = parseFloat(currentInput);
            let result;
            switch (operator) {
                case '+': result = prev + curr; break;
                case '-': result = prev - curr; break;
                case '*': result = prev * curr; break;
                default: return;
            }
            currentInput = result.toString();
            operator = null;
            previousInput = '';
        };

        const handleClear = () => {
            currentInput = '0';
            previousInput = '';
            operator = null;
        };

        // Create and render calculator buttons
        const buttonLayout = [
            '7', '8', '9', '+',
            '4', '5', '6', '-',
            '1', '2', '3', '*',
            'C', '0', '='
        ];
        buttonLayout.forEach(val => {
            const btn = document.createElement('button');
            btn.textContent = val;
            btn.className = 'calculator-btn text-white font-bold py-4 rounded-lg text-xl';
            if (['C', '*', '-', '+', '='].includes(val)) {
                btn.classList.add('bg-gray-700');
            }
            if (val === '=') {
                btn.style.gridColumn = 'span 2';
            }
            btn.dataset.value = val;
            buttonsContainer.appendChild(btn);
        });

        buttonsContainer.addEventListener('click', (e) => {
            const value = e.target.dataset.value;
            if (!value) return;

            if (!isNaN(parseFloat(value)) || value === '.') {
                handleNumber(value);
            } else if (value === 'C') {
                handleClear();
            } else if (value === '=') {
                handleEquals();
            } else {
                handleOperator(value);
            }
            updateDisplay();
        });

        document.getElementById('close-calculator-btn').addEventListener('click', () => hideModal('calculatorModal'));
    };

    // --- EVENT HANDLERS ---
    document.getElementById('create-session-btn').addEventListener('click', () => showView('tcgSelection'));
    document.getElementById('join-session-btn').addEventListener('click', () => {
        document.getElementById('join-player-name').value = appState.playerName;
        showModal('joinSessionModal');
    });
    document.getElementById('back-to-home-from-tcg').addEventListener('click', () => showView('home'));
    
    const setupGameSettings = (tcg) => {
        appState.game.tcg = tcg;
        document.getElementById('player-name-input').value = appState.playerName;
        
        document.getElementById('prize-card-settings').style.display = tcg === 'pokemon' ? 'block' : 'none';
        document.getElementById('additional-tracking-settings').style.display = tcg === 'pokemon' ? 'block' : 'none';
        document.getElementById('lorcana-lore-settings').style.display = tcg === 'lorcana' ? 'block' : 'none';
        document.getElementById('mtg-life-settings').style.display = tcg === 'mtg' ? 'block' : 'none';
        document.getElementById('yugioh-lp-settings').style.display = tcg === 'yugioh' ? 'block' : 'none';
        document.getElementById('onepiece-settings').style.display = tcg === 'onepiece' ? 'block' : 'none';

        const isCountdown = appState.game.timerType === 'countdown';
        document.getElementById('countdown-timer-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('number-of-games-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('chess-timer-settings').style.display = isCountdown ? 'none' : 'block';
        showModal('gameSettingsModal');
    };

    document.getElementById('select-pokemon').addEventListener('click', () => setupGameSettings('pokemon'));
    document.getElementById('select-lorcana').addEventListener('click', () => setupGameSettings('lorcana'));
    document.getElementById('select-mtg').addEventListener('click', () => setupGameSettings('mtg'));
    document.getElementById('select-yugioh').addEventListener('click', () => setupGameSettings('yugioh'));
    document.getElementById('select-onepiece').addEventListener('click', () => setupGameSettings('onepiece'));

    document.querySelectorAll('.prize-option-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.prize-option-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.prizeCount = parseInt(btn.dataset.prizes);
    }));
    document.querySelectorAll('.tracking-option-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.tracking-option-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.additionalTrackingEnabled = btn.dataset.tracking === 'true';
    }));
    document.querySelectorAll('.don-option-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.don-option-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.donTrackerEnabled = btn.dataset.don === 'true';
    }));
    document.querySelectorAll('.timer-type-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.timer-type-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.timerType = btn.dataset.timer;
        const isCountdown = appState.game.timerType === 'countdown';
        document.getElementById('countdown-timer-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('number-of-games-settings').style.display = isCountdown ? 'block' : 'none';
        document.getElementById('chess-timer-settings').style.display = isCountdown ? 'none' : 'block';
        if (!isCountdown) {
            appState.game.gameMode = 'basic';
        }
    }));
    document.querySelectorAll('.game-mode-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('.game-mode-btn').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-600'));
        btn.classList.replace('bg-gray-600', 'bg-blue-600');
        appState.game.gameMode = btn.dataset.mode;
    }));
    document.getElementById('cancel-settings-btn').addEventListener('click', () => hideModal('gameSettingsModal'));
    document.getElementById('cancel-join-btn').addEventListener('click', () => hideModal('joinSessionModal'));
    
    document.getElementById('confirm-create-btn').addEventListener('click', () => {
        appState.playerName = document.getElementById('player-name-input').value || appState.playerName;
        appState.game.countdownMinutes = parseInt(document.getElementById('countdown-minutes').value) || 30;
        appState.game.chessMinutes = parseInt(document.getElementById('chess-minutes').value) || 20;
        appState.game.loreToWin = parseInt(document.getElementById('lore-to-win-input').value) || 20;
        appState.game.startingLife = parseInt(document.getElementById('starting-life-input').value) || 20;
        appState.game.startingLP = parseInt(document.getElementById('starting-lp-input').value) || 8000;

        const sessionData = {
            roomCode: generateRoomCode(),
            isHost: true,
            playerName: appState.playerName,
            view: 'gameRoom',
            game: appState.game
        };
        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
        init();
    });

    document.getElementById('confirm-join-btn').addEventListener('click', () => {
        const roomCode = document.getElementById('room-code-input').value;
        const playerName = document.getElementById('join-player-name').value;
        if (!roomCode || roomCode.length !== 5 || !playerName) {
            console.error('Please enter a valid name and 5-digit room code.');
            return;
        }
        const sessionData = {
            roomCode: roomCode,
            isHost: false,
            playerName: playerName,
            view: 'gameRoom'
        };
        sessionStorage.setItem('tcgBattleSession', JSON.stringify(sessionData));
        init();
    });
    document.getElementById('prize-card-grid').addEventListener('click', (e) => {
        if (e.target.classList.contains('prize-card') && appState.game.status === 'active') {
            const prizeId = parseInt(e.target.dataset.prizeId);
            const myPlayer = appState.game.players[appState.myId];
            if (!myPlayer) return;
            const myPrizes = myPlayer.prizesTaken;
            if (myPrizes.includes(prizeId)) {
                myPrizes.splice(myPrizes.indexOf(prizeId), 1);
            } else {
                myPrizes.push(prizeId);
            }
            
            if (appState.isHost) {
                if (myPrizes.length >= appState.game.prizeCount) {
                    handleGameWin(appState.myId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            } else {
                appState.channel.trigger('client-update-prizes', { prizes: myPrizes });
            }
        }
    });
    
    document.getElementById('game-menu-dropdown').addEventListener('click', (e) => {
        const targetId = e.target.id;

        if (targetId !== 'open-presenter-btn') {
            e.preventDefault();
        }

        if (targetId === 'start-game-btn') {
            const pIds = Object.keys(appState.game.players);
            if (pIds.length < 2) {
                console.error("Cannot start, waiting for a guest to join.");
                return;
            }
            if (appState.game.tcg === 'onepiece') {
                appState.game.status = 'setting_life';
                broadcastGameState();
                showModal('setStartingLifeModal');
            } else {
                renderChooseFirstPlayerModal();
            }
        } else if (targetId === 'restart-round-btn') {
            restartRound();
        } else if (targetId === 'issue-win-btn') {
            renderIssueWinModal();
        } else if (targetId === 'kick-guest-btn') {
            const guestId = Object.keys(appState.game.players).find(id => !appState.game.players[id].isHost);
            if(guestId) {
                appState.channel.trigger('client-player-leave', {id: guestId});
                delete appState.game.players[guestId];
                broadcastGameState();
            }
        } else if (targetId === 'end-session-btn') {
            appState.channel.trigger('client-session-ended', {});
            setTimeout(() => {
                sessionStorage.removeItem('tcgBattleSession');
                localStorage.removeItem(`tcgBattleState-${appState.roomCode}`);
                window.location.href = window.location.pathname;
            }, 500);
        } else if (targetId === 'leave-battle-btn') {
            sessionStorage.removeItem('tcgBattleSession');
            window.location.href = window.location.pathname;
        } else if (targetId === 'open-presenter-btn') {
            const presenterUrl = `${window.location.origin}${window.location.pathname}?presenter=${appState.roomCode}`;
            window.open(presenterUrl, '_blank');
        }

        document.getElementById('game-menu-dropdown').classList.add('hidden');
    });

    document.getElementById('game-menu-btn').addEventListener('click', () => {
        document.getElementById('game-menu-dropdown').classList.toggle('hidden');
    });

    document.getElementById('first-player-options').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const firstPlayerId = e.target.dataset.playerId;
            if (firstPlayerId) {
                hideModal('chooseFirstPlayerModal');
                const isFirstGame = appState.game.status === 'waiting' || appState.game.status === 'setting_life';
                startGameWithFirstPlayer(firstPlayerId, isFirstGame);
            }
        }
    });

    document.getElementById('issue-win-options').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const winnerId = e.target.dataset.playerId;
            if (winnerId === 'tie') {
                hideModal('issueWinModal');
                handleTie();
            } else if (winnerId) {
                hideModal('issueWinModal');
                handleIssueWin(winnerId);
            }
        }
    });

    document.getElementById('cancel-issue-win-btn').addEventListener('click', () => hideModal('issueWinModal'));

    document.getElementById('zero-life-yes-btn').addEventListener('click', () => {
        hideModal('zeroLifeModal');
        renderIssueWinModal();
    });
    document.getElementById('zero-life-no-btn').addEventListener('click', () => hideModal('zeroLifeModal'));

    const startNextGame = () => {
        hideModal('winnerModal');
        if (appState.game.tcg === 'onepiece') {
            appState.game.status = 'setting_life';
            broadcastGameState();
            showModal('setStartingLifeModal');
        } else {
            renderChooseFirstPlayerModal();
        }
    };

    const restartRound = () => {
        Object.values(appState.game.players).forEach(p => {
            p.prizesTaken = [];
            p.loreCount = 0;
            p.life = appState.game.startingLife;
            p.lp = appState.game.startingLP;
            p.don = { active: 0, rested: 0 };
            p.actionsUsed = { supporter: false, energy: false, retreat: false, stadium: false };
            p.lifeSubmitted = false;
        });
        appState.game.status = 'waiting';
        appState.game.timerState = { running: false, startTime: null, elapsed: 0, playerTimes: {} };
        appState.game.wins = {};
        appState.game.currentGame = 1;
        appState.game.roundWinnerId = null;
        appState.game.isTie = false;
        appState.game.winnerId = null;
        appState.winnerAnnounced = false;
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        hideModal('winnerModal');
        broadcastGameState();
        fullRender();
    };

    document.getElementById('winner-modal-buttons').addEventListener('click', (e) => {
        if (e.target.id === 'play-again-btn' && appState.isHost) {
            restartRound();
        } else if (e.target.id === 'next-game-btn' && appState.isHost) {
            startNextGame();
        } else if (e.target.id === 'close-winner-btn') {
            hideModal('winnerModal');
        }
    });

    document.getElementById('additional-tracking-buttons').addEventListener('click', (e) => {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;
        
        const action = btn.dataset.action;
        const myPlayer = appState.game.players[appState.myId];
        const isUsed = !myPlayer.actionsUsed[action]; // Toggle the state

        if (appState.isHost) {
            myPlayer.actionsUsed[action] = isUsed;
            broadcastGameState();
            fullRender();
        } else {
            appState.channel.trigger('client-update-action', { action, used: isUsed });
        }
    });

    document.body.addEventListener('click', (e) => {
        const myPlayer = appState.game.players[appState.myId];
        if (!myPlayer) return;

        let lifeChanged = false;
        let newLife = myPlayer.life;

        if (e.target.closest('#life-up-btn') || e.target.closest('#op-life-up-btn')) {
            newLife++;
            lifeChanged = true;
        }
        if (e.target.closest('#life-down-btn') || e.target.closest('#op-life-down-btn')) {
            newLife--;
            lifeChanged = true;
        }

        if (lifeChanged) {
            if (newLife < 0) newLife = 0; // Prevent life from going below 0
            myPlayer.life = newLife;
            if (appState.isHost) {
                if(appState.game.tcg === 'mtg' && newLife <= 0) {
                    document.getElementById('zero-life-prompt').textContent = `${myPlayer.name} is at 0 life. Did they lose the game?`;
                    showModal('zeroLifeModal');
                }
                broadcastGameState();
                fullRender();
            } else {
                appState.channel.trigger('client-update-life', { life: newLife });
            }
        }
        
        if (e.target.closest('#lore-up-btn')) {
            myPlayer.loreCount++;
            if (appState.isHost) {
                if (myPlayer.loreCount >= appState.game.loreToWin) {
                    handleGameWin(appState.myId);
                } else {
                    broadcastGameState();
                    fullRender();
                }
            } else {
                appState.channel.trigger('client-update-lore', { loreCount: myPlayer.loreCount });
            }
        }
        if (e.target.closest('#lore-down-btn')) {
            if (myPlayer.loreCount > 0) {
                myPlayer.loreCount--;
                if (appState.isHost) {
                    broadcastGameState();
                    fullRender();
                } else {
                    appState.channel.trigger('client-update-lore', { loreCount: myPlayer.loreCount });
                }
            }
        }
        if (e.target.id === 'end-turn-btn') {
            const pIds = Object.keys(appState.game.players);
            const myId = appState.myId;
            const otherPlayerId = pIds.find(id => id !== myId);
            
            if (appState.isHost) {
                if (appState.game.players[myId]) {
                    appState.game.players[myId].actionsUsed = { supporter: false, energy: false, retreat: false, stadium: false };
                    if(appState.game.tcg === 'onepiece' && appState.game.donTrackerEnabled) {
                        appState.game.players[myId].don = { active: 0, rested: 0 };
                    }
                }
                appState.game.turn = otherPlayerId;
                broadcastGameState();
                fullRender();
            } else {
                appState.channel.trigger('client-end-turn', { turn: otherPlayerId });
            }
        }
        if (e.target.id === 'scoop-btn') {
            if (appState.isHost) {
                handleScoop(appState.myId);
            } else {
                appState.channel.trigger('client-scoop-game', {});
            }
        }
        if (document.getElementById('game-menu-dropdown') && !document.getElementById('game-menu-btn').contains(e.target) && !document.getElementById('game-menu-dropdown').contains(e.target)) {
            document.getElementById('game-menu-dropdown').classList.add('hidden');
        }
    });
    document.getElementById('submit-starting-life-btn').addEventListener('click', () => {
        const lifeInput = document.getElementById('player-starting-life-input');
        const life = parseInt(lifeInput.value, 10) || 5;
        
        document.getElementById('submit-starting-life-btn').classList.add('hidden');
        document.getElementById('waiting-for-life-submission').classList.remove('hidden');

        if (appState.isHost) {
            appState.game.players[appState.myId].life = life;
            appState.game.players[appState.myId].lifeSubmitted = true;
            const allSubmitted = Object.values(appState.game.players).every(p => p.lifeSubmitted);
            if (allSubmitted) {
                hideModal('setStartingLifeModal');
                renderChooseFirstPlayerModal();
            }
            broadcastGameState();
        } else {
            appState.channel.trigger('client-submit-life', { life });
        }
    });
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    fullscreenBtn.addEventListener('click', () => {
        const elem = document.documentElement;
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    });

document.getElementById('yugioh-controls').addEventListener('click', (e) => {
    const myPlayer = appState.game.players[appState.myId];
    if (!myPlayer) return;

    const lpBtn = e.target.closest('.lp-btn');
    if (lpBtn) {
        const amount = parseInt(lpBtn.dataset.lp, 10);
        let newLP = myPlayer.lp + amount;
        if (newLP < 0) newLP = 0; // Prevent LP from going below 0

        if (appState.isHost) {
            myPlayer.lp = newLP;
            if (newLP <= 0) {
                const opponentId = Object.keys(appState.game.players).find(id => id !== appState.myId);
                if (opponentId) handleGameWin(opponentId);
            } else {
                broadcastGameState();
                fullRender();
            }
        } else {
            appState.channel.trigger('client-update-lp', { lp: newLP });
        }
    }

    if (e.target.closest('#calculator-open-btn')) {
        showModal('calculatorModal');
    }
});
// --- INITIALIZATION ---
const init = async () => {
    // First, determine the view and render the basic UI
    const urlParams = new URLSearchParams(window.location.search);
    const presenterCode = urlParams.get('presenter');
    const roomToJoin = urlParams.get('join');
    const savedSession = sessionStorage.getItem('tcgBattleSession');

    if (presenterCode) {
        showView('presenter');
    } else if (savedSession) {
        const sessionData = JSON.parse(savedSession);
        showView(sessionData.view || 'home');
    } else if (roomToJoin) {
        document.getElementById('room-code-input').value = roomToJoin;
        showModal('joinSessionModal');
        showView('home');
    } else {
        showView('home');
    }

    // Now, try to fetch the config and initialize Pusher
    try {
        const response = await fetch('/.netlify/functions/pusher-config');
        if (!response.ok) throw new Error('Network response was not ok');
        const config = await response.json();
        
        PUSHER_APP_KEY = config.key;
        PUSHER_CLUSTER = config.cluster;
    } catch (error) {
        console.error("Could not fetch Pusher config:", error);
        // Do not block rendering. The user will only see an issue if they try to create/join a game.
    }

    // Proceed with connection logic only if we have keys and a session
    if (PUSHER_APP_KEY && (presenterCode || savedSession)) {
        if (presenterCode) {
            appState.isHost = false;
            appState.myId = `presenter_${Date.now()}`;
            initPusher();
            subscribeToChannel(presenterCode);
        } else if (savedSession) {
            const sessionData = JSON.parse(savedSession);
            appState.roomCode = sessionData.roomCode;
            appState.isHost = sessionData.isHost;
            appState.playerName = sessionData.playerName;
            
            if (sessionData.isHost) {
                const savedGameState = localStorage.getItem(`tcgBattleState-${appState.roomCode}`);
                if (savedGameState) {
                    appState.game = JSON.parse(savedGameState);
                }
            }
            
            initPusher();
            subscribeToChannel(appState.roomCode);
            fullRender();
        }
    }
};

    init();
    initCalculator();
});
</script>

</body>
</html>

